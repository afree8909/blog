<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"afree8909.github.io","root":"/blog/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":20},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Afree&#39;s blog">
<meta property="og:url" content="https://afree8909.github.io/blog/page/3/index.html">
<meta property="og:site_name" content="Afree&#39;s blog">
<meta property="article:author" content="Afree">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://afree8909.github.io/blog/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>Afree's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Afree's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">保持好奇心，不畏边界，持续学习</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/25/Android%E7%B3%BB%E7%BB%9F_Surface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/25/Android%E7%B3%BB%E7%BB%9F_Surface/" class="post-title-link" itemprop="url">Android系统_Surface</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-25 11:14:17" itemprop="dateCreated datePublished" datetime="2019-11-25T11:14:17+08:00">2019-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:11:09" itemprop="dateModified" datetime="2020-02-07T01:11:09+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>基于API 23</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-b7271e93c8490bde.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="SurfaceComposerClient的创建过程"><a href="#SurfaceComposerClient的创建过程" class="headerlink" title="SurfaceComposerClient的创建过程"></a>SurfaceComposerClient的创建过程</h3><h4 id="WMS-addWinodw"><a href="#WMS-addWinodw" class="headerlink" title="WMS.addWinodw"></a>WMS.addWinodw</h4><p>WMS添加window过程，最后会执行到session.windowAddedLocked</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;WMS</span><br><span class="line">public int addWindow(Session session, IWindow client, int seq, WindowManager.LayoutParams attrs, int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets, Rect outOutsets, InputChannel outInputChannel) &#123;</span><br><span class="line">    ...</span><br><span class="line">    win.attach(); &#x2F;&#x2F; WindowState</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; WindowState.attch</span><br><span class="line">void attach() &#123;</span><br><span class="line">    mSession.windowAddedLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Session-windowAddedLocked"><a href="#Session-windowAddedLocked" class="headerlink" title="Session.windowAddedLocked"></a>Session.windowAddedLocked</h4><p>创建 SurfaceSession 对象，并将当前 Session 添加到 WMS.mSessions 成员变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void windowAddedLocked() &#123;</span><br><span class="line">    if (mSurfaceSession &#x3D;&#x3D; null) &#123;</span><br><span class="line">        mSurfaceSession &#x3D; new SurfaceSession();</span><br><span class="line">        mService.mSessions.add(this);</span><br><span class="line">        if (mLastReportedAnimatorScale !&#x3D; mService.getCurrentAnimatorScale()) &#123;</span><br><span class="line">            mService.dispatchNewAnimatorScaleLocked(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mNumWindow++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="android-view-SurfaceSession-cpp"><a href="#android-view-SurfaceSession-cpp" class="headerlink" title="android_view_SurfaceSession.cpp"></a>android_view_SurfaceSession.cpp</h4><p>SurfaceSession 的创建会调用 JNI，在 JNI 调用 nativeCreate()<br>构造了一个SurfaceComposerClient对象。并返回它的指针。这个对象一个应用程序就有一个，它是应用程序与SurfaceFlinger沟通的桥梁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SurfaceSeesion</span><br><span class="line">public SurfaceSession() &#123;</span><br><span class="line">   mNativeClient &#x3D; nativeCreate();</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; JNI</span><br><span class="line">static jlong nativeCreate(JNIEnv* env, jclass clazz) &#123;</span><br><span class="line">    &#x2F;&#x2F; 创建 SurfaceComposeClient 空实现，查看onFirstRef</span><br><span class="line">    SurfaceComposerClient* client &#x3D; new SurfaceComposerClient();</span><br><span class="line">    client-&gt;incStrong((void*)nativeCreate);</span><br><span class="line">    return reinterpret_cast&lt;jlong&gt;(client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceComposerClient-onFirstRef"><a href="#SurfaceComposerClient-onFirstRef" class="headerlink" title="SurfaceComposerClient.onFirstRef"></a>SurfaceComposerClient.onFirstRef</h4><p>通过SurfaceFlinger创造了一个Client对象，每一个APP都有一个Client对象向对应，通过这个代理对象可以跟SurfaceFlinger通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void SurfaceComposerClient::onFirstRef() &#123;</span><br><span class="line">    ....</span><br><span class="line">    sp&lt;ISurfaceComposerClient&gt; conn;</span><br><span class="line">    &#x2F;&#x2F;sf 就是SurfaceFlinger</span><br><span class="line">    conn &#x3D; (rootProducer !&#x3D; nullptr) ? sf-&gt;createScopedConnection(rootProducer) :</span><br><span class="line">            sf-&gt;createConnection();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceFlinger-cpp"><a href="#SurfaceFlinger-cpp" class="headerlink" title="SurfaceFlinger.cpp"></a>SurfaceFlinger.cpp</h4><p>构造了一个Client对象，Client实现了ISurfaceComposerClient接口。是一个可以跨进程通信的aidl对象。除此之外它还可以创建Surface，并且维护一个应用程序的所有Layer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;ISurfaceComposerClient&gt; SurfaceFlinger::createConnection()&#123;</span><br><span class="line">  sp&lt;ISurfaceComposerClient&gt; bclient;</span><br><span class="line">  sp&lt;Client&gt; client(new Client(this));</span><br><span class="line">  return bclient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client-h"><a href="#Client-h" class="headerlink" title="Client.h"></a>Client.h</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Client : public BnSurfaceComposerClient</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    </span><br><span class="line">    void attachLayer(const sp&lt;IBinder&gt;&amp; handle, const sp&lt;Layer&gt;&amp; layer);</span><br><span class="line">    void detachLayer(const Layer* layer);</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="Surface的创建"><a href="#Surface的创建" class="headerlink" title="Surface的创建"></a>Surface的创建</h3><p>一个ViewRootImpl就对应一个Surface</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final Surface mSurface &#x3D; new Surface();</span><br><span class="line"></span><br><span class="line">public Surface() &#123;</span><br><span class="line">    &#x2F;&#x2F; 空构造函数，需要继续追看Surface赋值过程</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ViewRootImpl-relayoutWindow"><a href="#ViewRootImpl-relayoutWindow" class="headerlink" title="ViewRootImpl.relayoutWindow"></a>ViewRootImpl.relayoutWindow</h4><p>直接看ViewRootImpl的绘制流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void performTraversals() &#123;</span><br><span class="line">    finalView host &#x3D; mView; &#x2F;&#x2F;mView是一个Window的根View，对于Activity来说就是DecorView</span><br><span class="line">    ...</span><br><span class="line">    relayoutWindow(params, viewVisibility, insetsPending);</span><br><span class="line">    ...</span><br><span class="line">    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    ...         </span><br><span class="line">    performLayout(lp, mWidth, mHeight);</span><br><span class="line">    ...</span><br><span class="line">    performDraw();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 重布window</span><br><span class="line">private int relayoutWindow(WindowManager.LayoutParams params, ...) throws RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    int relayoutResult &#x3D; mWindowSession.relayout(mWindow,..., mSurface);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="WindowManagerService-relayoutWindow"><a href="#WindowManagerService-relayoutWindow" class="headerlink" title="WindowManagerService.relayoutWindow"></a>WindowManagerService.relayoutWindow</h4><p>winAnimator.createSurfaceLocked实际上是创建了一个SurfaceControl。即上面是先构造SurfaceControl，然后在构造Surface</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public int relayoutWindow(Session session, IWindow client....Surface outSurface)&#123; </span><br><span class="line">    ...</span><br><span class="line">    result &#x3D; createSurfaceControl(outSurface, result, win, winAnimator);  </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private int createSurfaceControl(Surface outSurface, int result, WindowState win,WindowStateAnimator winAnimator) &#123;</span><br><span class="line">    ...</span><br><span class="line">    surfaceController &#x3D; winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</span><br><span class="line">    ...</span><br><span class="line">    surfaceController.getSurface(outSurface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceControl的创建"><a href="#SurfaceControl的创建" class="headerlink" title="SurfaceControl的创建"></a>SurfaceControl的创建</h4><p>通过SurfaceControl的构造函数创建了一个SurfaceControl对象,这个对象的作用其实就是负责维护Surface,Surface其实也是由这个对象负责创建的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">long mNativeObject; &#x2F;&#x2F;成员指针变量，指向native创建的SurfaceControl</span><br><span class="line"></span><br><span class="line">private SurfaceControl(...)&#123;</span><br><span class="line">    ...</span><br><span class="line">    mNativeObject &#x3D; nativeCreate(session, name, w, h, format, flags,</span><br><span class="line">        parent !&#x3D; null ? parent.mNativeObject : 0, windowType, ownerUid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="android-view-SurfaceControl-cpp"><a href="#android-view-SurfaceControl-cpp" class="headerlink" title="android_view_SurfaceControl.cpp"></a>android_view_SurfaceControl.cpp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static jlong nativeCreate(JNIEnv* env, ...) &#123;</span><br><span class="line">    &#x2F;&#x2F;这个client为前面创建的SurfaceComposerClinent</span><br><span class="line">    sp&lt;SurfaceComposerClient&gt; client(android_view_SurfaceSession_getClient(env, sessionObj)); </span><br><span class="line">    &#x2F;&#x2F;创建成功之后，这个指针会指向新创建的SurfaceControl</span><br><span class="line">    sp&lt;SurfaceControl&gt; surface;</span><br><span class="line">    status_t err &#x3D; client-&gt;createSurface(String8(name.c_str()), w, h, format, &amp;surface, flags, parent, windowType, ownerUid);</span><br><span class="line">    ...</span><br><span class="line">    return reinterpret_cast&lt;jlong&gt;(surface.get()); &#x2F;&#x2F;返回这个SurfaceControl的地址</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceComposerClient-createSurface"><a href="#SurfaceComposerClient-createSurface" class="headerlink" title="SurfaceComposerClient.createSurface"></a>SurfaceComposerClient.createSurface</h4><p>创建时传入了一个对象 sp<IGraphicBufferProducer> gbp, 后面会说吗应用所渲染的每一帧，实际上都会添加到IGraphicBufferProducer中，来等待SurfaceFlinger的渲染</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;outSurface会指向新创建的SurfaceControl</span><br><span class="line">status_t SurfaceComposerClient::createSurface(...sp&lt;SurfaceControl&gt;* outSurface..) </span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; gbp; </span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 调用 之前缓存的client进行创建</span><br><span class="line">    err &#x3D; mClient-&gt;createSurface(name, w, h, format, flags, parentHandle, windowType, ownerUid, &amp;handle, &amp;gbp);</span><br><span class="line">    if (err &#x3D;&#x3D; NO_ERROR) &#123;</span><br><span class="line">        &#x2F;&#x2F;SurfaceControl创建成功, 指针赋值</span><br><span class="line">        sur &#x3D; new SurfaceControl(this, handle, gbp, true);</span><br><span class="line">    &#125;</span><br><span class="line">    return sur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Client-createSurface"><a href="#Client-createSurface" class="headerlink" title="Client.createSurface"></a>Client.createSurface</h4><p>Client将应用程序创建Surface的请求转换为异步消息投递到SurfaceFlinger的消息队列中，将创建Surface的任务转交给SurfaceFlinger，因为同一时刻可以有多个应用程序请求SurfaceFlinger为其创建Surface，通过消息队列可以实现请求排队，然后SurfaceFlinger依次为应用程序创建Surface</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">status_t Client::createSurface(</span><br><span class="line">        const String8&amp; name,</span><br><span class="line">        uint32_t w, uint32_t h, PixelFormat format, uint32_t flags,</span><br><span class="line">        sp&lt;IBinder&gt;* handle,</span><br><span class="line">        sp&lt;IGraphicBufferProducer&gt;* gbp)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    sp&lt;MessageBase&gt; msg &#x3D; new MessageCreateLayer(mFlinger.get(),</span><br><span class="line">            name, this, w, h, format, flags, handle, gbp);</span><br><span class="line">    mFlinger-&gt;postMessageSync(msg);</span><br><span class="line">    return static_cast&lt;MessageCreateLayer*&gt;( msg.get() )-&gt;getResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceFlinger-createLayer"><a href="#SurfaceFlinger-createLayer" class="headerlink" title="SurfaceFlinger.createLayer"></a>SurfaceFlinger.createLayer</h4><p>该函数中根据flag创建不同的Layer，Layer用于标示一个图层。<br>除了SurfaceFlinger需要统一管理系统中创建的所有Layer对象外，专门为每个应用程序进程服务的Client也需要统一管理当前应用程序进程所创建的Layer，因此在addClientLayer函数里还会通过Client::attachLayer将创建的Layer和该类对应的handle以键值对的方式保存到Client的成员变量mLayers表中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">status_t SurfaceFlinger::createLayer(const String8&amp; name,const sp&lt;Client&gt;&amp; client...)</span><br><span class="line">&#123;</span><br><span class="line">    status_t result &#x3D; NO_ERROR;</span><br><span class="line">    &#x2F;&#x2F;创建的layer</span><br><span class="line">    sp&lt;Layer&gt; layer; </span><br><span class="line">    switch (flags &amp; ISurfaceComposerClient::eFXSurfaceMask) &#123;</span><br><span class="line">        case ISurfaceComposerClient::eFXSurfaceNormal:</span><br><span class="line">            result &#x3D; createBufferLayer(client,</span><br><span class="line">                    uniqueName, w, h, flags, format,</span><br><span class="line">                    handle, gbp, &amp;layer);</span><br><span class="line">            break;</span><br><span class="line">            ... &#x2F;&#x2F;Layer 其它情况的创建</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F;这个layer和client相关联, 添加到Client的mLayers集合中</span><br><span class="line">    result &#x3D; addClientLayer(client, *handle, *gbp, layer, *parent);  </span><br><span class="line">    ...</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SurfaceFlinger-createNormalLayer"><a href="#SurfaceFlinger-createNormalLayer" class="headerlink" title="SurfaceFlinger.createNormalLayer"></a>SurfaceFlinger.createNormalLayer</h4><p>SurfaceFlinger为应用程序创建好Layer后，需要统一管理这些Layer对象，因此通过函数addClientLayer将创建的Layer保存到当前State的Z秩序列表layersSortedByZ中，同时将这个Layer所对应的IGraphicBufferProducer本地Binder对象gbp保存到SurfaceFlinger的成员变量mGraphicBufferProducerList中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">status_t SurfaceFlinger::createNormalLayer(const sp&lt;Client&gt;&amp; client,</span><br><span class="line">        const String8&amp; name, uint32_t w, uint32_t h, uint32_t flags, PixelFormat&amp; format,</span><br><span class="line">        sp&lt;IBinder&gt;* handle, sp&lt;IGraphicBufferProducer&gt;* gbp, sp&lt;Layer&gt;* outLayer)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; initialize the surfaces</span><br><span class="line">    switch (format) &#123;</span><br><span class="line">    case PIXEL_FORMAT_TRANSPARENT:</span><br><span class="line">    case PIXEL_FORMAT_TRANSLUCENT:</span><br><span class="line">        format &#x3D; PIXEL_FORMAT_RGBA_8888;</span><br><span class="line">        break;</span><br><span class="line">    case PIXEL_FORMAT_OPAQUE:</span><br><span class="line">        format &#x3D; PIXEL_FORMAT_RGBX_8888;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *outLayer &#x3D; new Layer(this, client, name, w, h, flags);</span><br><span class="line">    status_t err &#x3D; (*outLayer)-&gt;setBuffers(w, h, format, flags);</span><br><span class="line">    if (err &#x3D;&#x3D; NO_ERROR) &#123;</span><br><span class="line">        *handle &#x3D; (*outLayer)-&gt;getHandle();</span><br><span class="line">        *gbp &#x3D; (*outLayer)-&gt;getProducer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ALOGE_IF(err, &quot;createNormalLayer() failed (%s)&quot;, strerror(-err));</span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Layer-cpp"><a href="#Layer-cpp" class="headerlink" title="Layer.cpp"></a>Layer.cpp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void Layer::onFirstRef() &#123;</span><br><span class="line">    &#x2F;&#x2F; Creates a custom BufferQueue for SurfaceFlingerConsumer to use</span><br><span class="line">    sp&lt;IGraphicBufferProducer&gt; producer;</span><br><span class="line">    sp&lt;IGraphicBufferConsumer&gt; consumer;</span><br><span class="line">    BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</span><br><span class="line">    mProducer &#x3D; new MonitoredProducer(producer, mFlinger);</span><br><span class="line">    mSurfaceFlingerConsumer &#x3D; new SurfaceFlingerConsumer(consumer, mTextureName);</span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(0));</span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setContentsChangedListener(this);</span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setName(mName);</span><br><span class="line"></span><br><span class="line">#ifdef TARGET_DISABLE_TRIPLE_BUFFERING</span><br><span class="line">#warning &quot;disabling triple buffering&quot;</span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setDefaultMaxBufferCount(2);</span><br><span class="line">#else</span><br><span class="line">    mSurfaceFlingerConsumer-&gt;setDefaultMaxBufferCount(3);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    const sp&lt;const DisplayDevice&gt; hw(mFlinger-&gt;getDefaultDisplayDevice());</span><br><span class="line">    updateTransformHint(hw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="BufferQueue-cpp"><a href="#BufferQueue-cpp" class="headerlink" title="BufferQueue.cpp"></a>BufferQueue.cpp</h4><ul>
<li>BufferQueue是一个服务中心，IGraphicBufferProducer和IGraphicBufferConsumer<br>所需要使用的buffer必须要通过它来管理。比如说当IGraphicBufferProducer想要获取一个buffer时，它不能越过BufferQueue直接与IGraphicBufferConsumer进行联系，反之亦然。</li>
<li>IGraphicBufferProducer就是“填充”buffer空间的人，通常情况下是应用程序。因为应用程序不断地刷新UI，从而将产生的显示数据源源不断地写到buffer中。当IGraphicBufferProducer需要使用一块buffer时，它首先会向中介BufferQueue发起dequeueBuffer申请，然后才能对指定的buffer进行操作。此时buffer就只属于IGraphicBufferProducer一个人的了，它可以对buffer进行任何必要的操作，而IGraphicBufferConsumer此刻绝不能操作这块buffer。当IGraphicBufferProducer认为一块buffer已经写入完成后，它进一步调用queueBuffer函数。从字面上看这个函数是“入列”的意思，形象地表达了buffer此时的操作，把buffer归还到BufferQueue的队列中。一旦queue成功后，buffer的owner也就随之改变为BufferQueue了</li>
<li>IGraphicBufferConsumer是与IGraphicBufferProducer相对应的，它的操作同样受到BufferQueue的管控。当一块buffer已经就绪后，IGraphicBufferConsumer就可以开始工作了。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void BufferQueue::createBufferQueue(sp&lt;IGraphicBufferProducer&gt;* outProducer,</span><br><span class="line">        sp&lt;IGraphicBufferConsumer&gt;* outConsumer,</span><br><span class="line">        const sp&lt;IGraphicBufferAlloc&gt;&amp; allocator) &#123;</span><br><span class="line"></span><br><span class="line">    sp&lt;BufferQueueCore&gt; core(new BufferQueueCore(allocator));</span><br><span class="line">    *outProducer &#x3D; producer;</span><br><span class="line">    *outConsumer &#x3D; consumer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="从SurfaceControl中获取Surface"><a href="#从SurfaceControl中获取Surface" class="headerlink" title="从SurfaceControl中获取Surface"></a>从SurfaceControl中获取Surface</h4><p>上面完成了 surfaceController的创建跟踪，下面分析从surfaceController获取surface过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private int createSurfaceControl(Surface outSurface, int result, WindowState win,WindowStateAnimator winAnimator) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 上面完成了 surfaceController的创建</span><br><span class="line">    SurfaceControl surfaceController &#x3D; winAnimator.createSurfaceLocked();</span><br><span class="line">    &#x2F;&#x2F; 下面分析 surfaceController获取surface</span><br><span class="line">    outSurface.copyFrom(surfaceControl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="android-view-Surface-nativeCreateFromSurfaceControl"><a href="#android-view-Surface-nativeCreateFromSurfaceControl" class="headerlink" title="android_view_Surface.nativeCreateFromSurfaceControl"></a>android_view_Surface.nativeCreateFromSurfaceControl</h4><p>JNI构建方法获取到一个指针，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static jlong nativeCreateFromSurfaceControl(JNIEnv* env, jclass clazz, jlong surfaceControlNativeObj) &#123;</span><br><span class="line">    &#x2F;&#x2F; 把java指针转化内native指针</span><br><span class="line">    sp&lt;SurfaceControl&gt; ctrl(reinterpret_cast&lt;SurfaceControl *&gt;(surfaceControlNativeObj));</span><br><span class="line">    &#x2F;&#x2F; 直接构造一个Surface，指向 ctrl-&gt;getSurface()</span><br><span class="line">    sp&lt;Surface&gt; surface(ctrl-&gt;getSurface());</span><br><span class="line">    if (surface !&#x3D; NULL) &#123;</span><br><span class="line">        surface-&gt;incStrong(&amp;sRefBaseOwner); &#x2F;&#x2F;强引用</span><br><span class="line">    &#125;</span><br><span class="line">    return reinterpret_cast&lt;jlong&gt;(surface.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SurfaceControl-getSurface"><a href="#SurfaceControl-getSurface" class="headerlink" title="SurfaceControl.getSurface"></a>SurfaceControl.getSurface</h4><p>创建一个native层的Surface对象，并将该对象指针返回给Java层的Surface，从而建立Java层的Surface和native层Surface的关联关系<br>另外Surface和SurfaceControl都持有mGraphicBufferProducer用于操作位于SurfaceFlinger中的图形buffer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; SurfaceControl::getSurface() const</span><br><span class="line">&#123;</span><br><span class="line">    Mutex::Autolock _l(mLock);</span><br><span class="line">    if (mSurfaceData &#x3D;&#x3D; 0) &#123;</span><br><span class="line">         mSurfaceData &#x3D; new Surface(mGraphicBufferProducer, false);</span><br><span class="line">    &#125;</span><br><span class="line">    return mSurfaceData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/24/Android%E7%B3%BB%E7%BB%9F_Window%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/24/Android%E7%B3%BB%E7%BB%9F_Window%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E6%B7%BB%E5%8A%A0%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Android系统_Window的创建与添加过程分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-24 11:03:26" itemprop="dateCreated datePublished" datetime="2019-11-24T11:03:26+08:00">2019-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:11:00" itemprop="dateModified" datetime="2020-02-07T01:11:00+08:00">2020-02-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>tags: </p>
<ul>
<li>源码</li>
<li>Window<br>categories:</li>
<li>[Android, 系统]</li>
</ul>
<hr>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p>（大体流程，从Activity接受启动开始）</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-b817d3db3ce31ee5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><blockquote>
<p>基于API 23</p>
</blockquote>
<h4 id="Window创建"><a href="#Window创建" class="headerlink" title="Window创建"></a>Window创建</h4><h5 id="ActivityThread-handleLaunchActivity"><a href="#ActivityThread-handleLaunchActivity" class="headerlink" title="ActivityThread.handleLaunchActivity"></a>ActivityThread.handleLaunchActivity</h5><h5 id="ActivityThread-performLaunchActivity"><a href="#ActivityThread-performLaunchActivity" class="headerlink" title="ActivityThread.performLaunchActivity"></a>ActivityThread.performLaunchActivity</h5><p>ActivityThread处理并执行Activity启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ActivityThread</span><br><span class="line">private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F;获取WindowManagerService的Binder引用(proxy端)。</span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;执行Activity的onCreate,onStart,onResotreInstanceState方法</span><br><span class="line">    Activity a &#x3D; performLaunchActivity(r, customIntent);</span><br><span class="line">    if (a !&#x3D; null) &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F;执行Activity的onResume方法.</span><br><span class="line">        handleResumeActivity(r.token, false, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F;通过类加载器创建Activity</span><br><span class="line">   Activity activity &#x3D; mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line"></span><br><span class="line">   ...      </span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F;通过LoadedApk的makeApplication方法来创建Application对象</span><br><span class="line">   Application app &#x3D; r.packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   if (activity !&#x3D; null) &#123;</span><br><span class="line">       ...</span><br><span class="line">       &#x2F;&#x2F; 执行 attach 方法</span><br><span class="line">       activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">               r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">               r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">               r.referrer, r.voiceInteractor, window);</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;onCreate</span><br><span class="line">       mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;onStart</span><br><span class="line">       activity.performStart();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   return activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Activity-attach"><a href="#Activity-attach" class="headerlink" title="Activity.attach"></a>Activity.attach</h5><ul>
<li>构造PhoneWindow （Window唯一具体实现）</li>
<li>设置自身为Window的Callback，从而Activity能作为callback接受window的key和touch事件</li>
<li>初始化且设置WindowManager，每个Activity对应一个WindowManager，通过WM与WMS进行通信</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">final void attach(...) &#123;</span><br><span class="line">    &#x2F;&#x2F;绑定上下文</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;创建Window,PhoneWindow是Window的唯一具体实现类</span><br><span class="line">    mWindow &#x3D; new PhoneWindow(this, window);&#x2F;&#x2F;此处的window&#x3D;&#x3D;null，但不影响</span><br><span class="line">    mWindow.setWindowControllerCallback(this);</span><br><span class="line">    &#x2F;&#x2F; 设置 Window.Callback</span><br><span class="line">    mWindow.setCallback(this);</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F;设置WindowManager</span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">          (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">          mToken, mComponent.flattenToString(),</span><br><span class="line">          (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) !&#x3D; 0);</span><br><span class="line">    if (mParent !&#x3D; null) &#123;</span><br><span class="line">      mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;创建完后通过getWindowManager就可以得到WindowManager实例</span><br><span class="line">    mWindowManager &#x3D; mWindow.getWindowManager();&#x2F;&#x2F;其实它是WindowManagerImpl</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Window添加View过程"><a href="#Window添加View过程" class="headerlink" title="Window添加View过程"></a>Window添加View过程</h4><p>前面在handleLauncherActivity完成了PhoneWindow的创建过程，下面我们继续查看Activity执行生命周期handleResumeActivity方法，查看Activity对应View被加载到PhoneWindow容器过程</p>
<h5 id="ActivityThread-handleResumeActivity"><a href="#ActivityThread-handleResumeActivity" class="headerlink" title="ActivityThread.handleResumeActivity"></a>ActivityThread.handleResumeActivity</h5><ul>
<li>获取ActivityClientRecord，将对应DecorView设置为不可见，因为当前View还未绘制</li>
<li>通过Window对应的WindowManager执行addView（decor，l）操作</li>
<li>View绘制完成后，会将decorView设置可见，展示该Activity对应内容，最后onResume完成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">final void handleResumeActivity(IBinder token,</span><br><span class="line">            boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) &#123;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F;把activity数据记录更新到ActivityClientRecord</span><br><span class="line">   ActivityClientRecord r &#x3D; performResumeActivity(token, clearHide);</span><br><span class="line"></span><br><span class="line">   if (r !&#x3D; null) &#123;</span><br><span class="line"></span><br><span class="line">       if (r.window &#x3D;&#x3D; null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</span><br><span class="line">           r.window &#x3D; r.activity.getWindow();</span><br><span class="line">           View decor &#x3D; r.window.getDecorView();</span><br><span class="line">           decor.setVisibility(View.INVISIBLE);&#x2F;&#x2F;不可见</span><br><span class="line">           ViewManager wm &#x3D; a.getWindowManager();</span><br><span class="line">           WindowManager.LayoutParams l &#x3D; r.window.getAttributes();</span><br><span class="line">           a.mDecor &#x3D; decor;</span><br><span class="line">           l.type &#x3D; WindowManager.LayoutParams.TYPE_BASE_APPLICATION;</span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line">           if (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;</span><br><span class="line">               a.mWindowAdded &#x3D; true;</span><br><span class="line">               wm.addView(decor, l);&#x2F;&#x2F; 把decor添加到窗口上</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125; </span><br><span class="line">           &#x2F;&#x2F;屏幕参数发生了改变</span><br><span class="line">           performConfigurationChanged(r.activity, r.tmpConfig);</span><br><span class="line"></span><br><span class="line">           WindowManager.LayoutParams l &#x3D; r.window.getAttributes();</span><br><span class="line"></span><br><span class="line">               if (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">                   ViewManager wm &#x3D; a.getWindowManager();</span><br><span class="line">                   View decor &#x3D; r.window.getDecorView();</span><br><span class="line">                   wm.updateViewLayout(decor, l);&#x2F;&#x2F;更新窗口状态</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line">           if (r.activity.mVisibleFromClient) &#123;</span><br><span class="line">               &#x2F;&#x2F;已经成功添加到窗口上了（绘制和事件接收），设置为可见</span><br><span class="line">               r.activity.makeVisible();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;通知ActivityManagerService，Activity完成Resumed</span><br><span class="line">        ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">   &#125; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="WindowManagerImply-addView"><a href="#WindowManagerImply-addView" class="headerlink" title="WindowManagerImply.addView"></a>WindowManagerImply.addView</h5><h5 id="WindowManagerGlobal-addView"><a href="#WindowManagerGlobal-addView" class="headerlink" title="WindowManagerGlobal.addView"></a>WindowManagerGlobal.addView</h5><ul>
<li>WindowManagerImpl的全局变量通过单例模式初始化了WindowManagerGlobal，（一个进程一个WMG对象）</li>
<li>Window管理类添加View过程，创建ViewRootImpl，将View处理操作交给ViewRootImpl实现</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; WindowManagerImply</span><br><span class="line">public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) &#123;</span><br><span class="line">    applyDefaultToken(params);</span><br><span class="line">    mGlobal.addView(view, params, mDisplay, mParentWindow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; WindowManagerGlobal</span><br><span class="line">public void addView(View view, ViewGroup.LayoutParams params,</span><br><span class="line">           Display display, Window parentWindow) &#123;</span><br><span class="line">     </span><br><span class="line">    synchronized (mLock) &#123; </span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F; 创建ViewRootImpl，并将View与之绑定</span><br><span class="line">        root &#x3D; new ViewRootImpl(view.getContext(), display);</span><br><span class="line">        </span><br><span class="line">        view.setLayoutParams(wparams);</span><br><span class="line">        </span><br><span class="line">        mViews.add(view); &#x2F;&#x2F; 将当前view添加到mView集合中</span><br><span class="line">        mRoots.add(root); &#x2F;&#x2F; 将当前root添加mRoots集合中</span><br><span class="line">        mParams.add(wparams); &#x2F;&#x2F; 将当前window的params添加到mParams集合中</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; setView 完成View的绘制流程，并添加到window上 </span><br><span class="line">    root.setView(view, wparams, panelParentView);</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ViewRootImpl-setView"><a href="#ViewRootImpl-setView" class="headerlink" title="ViewRootImpl.setView"></a>ViewRootImpl.setView</h4><ul>
<li>ViewRootImpl构建过程中，会通过WindowManagerGlobal的getWindowSession（static方法）获取IWindowSession即WindowSession</li>
<li>执行requestLayout方法完成View的绘制流程</li>
<li>通过WindowSession与WindowManagerService通信，将View和InputChannel添加到WMS，从而展示View并可以接受输入事件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) &#123;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">      int res</span><br><span class="line">      requestLayout();&#x2F;&#x2F;执行 View的绘制流程</span><br><span class="line"></span><br><span class="line">      if ((mWindowAttributes.inputFeatures</span><br><span class="line">              &amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">          &#x2F;&#x2F; 创建InputChannel</span><br><span class="line">          mInputChannel &#x3D; new InputChannel();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F;通过WindowSession进行IPC调用，将View添加到Window上</span><br><span class="line">          &#x2F;&#x2F;mWindow即W类，用来接收WmS信息</span><br><span class="line">          &#x2F;&#x2F;同时通过InputChannel接收触摸事件回调</span><br><span class="line">          res &#x3D; mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">                  getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">                  mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</span><br><span class="line">                  mAttachInfo.mOutsets, mInputChannel);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F;处理触摸事件回调</span><br><span class="line">      mInputEventReceiver &#x3D; new WindowInputEventReceiver(mInputChannel,</span><br><span class="line">                  Looper.myLooper());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="WindowSession-addToDisplay"><a href="#WindowSession-addToDisplay" class="headerlink" title="WindowSession.addToDisplay"></a>WindowSession.addToDisplay</h4><ul>
<li>Session执行addToDisplay方法，通过调用成员变量WMS进行addWindow操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public int addToDisplay(...) &#123;</span><br><span class="line">   return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,</span><br><span class="line">           outContentInsets, outStableInsets, outOutsets, outInputChannel);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="WindowManagerService-addWindow"><a href="#WindowManagerService-addWindow" class="headerlink" title="WindowManagerService.addWindow"></a>WindowManagerService.addWindow</h4><ul>
<li>创建WindowState，保存Window状态</li>
<li>调整LayoutParams参数、设置input、设置window zOrder</li>
<li>执行WindowState的attach（创建Surface过程，详情见下一篇）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public int addWindow(Session session, IWindow client, int seq,</span><br><span class="line">       WindowManager.LayoutParams attrs, int viewVisibility, int displayId,</span><br><span class="line">       Rect outContentInsets, Rect outStableInsets, Rect outOutsets,InputChannel outInputChannel) &#123;</span><br><span class="line">   </span><br><span class="line">    ... &#x2F;&#x2F; 一堆check逻辑</span><br><span class="line"></span><br><span class="line">    WindowToken token &#x3D; mTokenMap.get(attrs.token);</span><br><span class="line">    &#x2F;&#x2F;创建 WindowState</span><br><span class="line">    WindowState win &#x3D; new WindowState(this, session, client, token,</span><br><span class="line">          attachedWindow, appOp[0], seq, attrs, viewVisibility, displayContent);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;调整 WindowManager 的 LayoutParams 参数</span><br><span class="line">    mPolicy.adjustWindowParamsLw(win.mAttrs);</span><br><span class="line">    res &#x3D; mPolicy.prepareAddWindowLw(win, attrs);</span><br><span class="line">    addWindowToListInOrderLocked(win, true);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 设置 input</span><br><span class="line">    mInputManager.registerInputChannel(win.mInputChannel, win.mInputWindowHandle);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 创建 Surface 与 SurfaceFlinger 通信，</span><br><span class="line">    win.attach();</span><br><span class="line">    mWindowMap.put(client.asBinder(), win);</span><br><span class="line">        </span><br><span class="line">    if (win.canReceiveKeys()) &#123;</span><br><span class="line">    &#x2F;&#x2F;当该窗口能接收按键事件，则更新聚焦窗口</span><br><span class="line">    focusChanged &#x3D; updateFocusedWindowLocked(UPDATE_FOCUS_WILL_ASSIGN_LAYERS,</span><br><span class="line">          false &#x2F;*updateInputWindows*&#x2F;);</span><br><span class="line">    &#125;</span><br><span class="line">    assignLayersLocked(displayContent.getWindowList());</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a><br>参考<br><a href="https://juejin.im/entry/5a123c31f265da430d579cda" target="_blank" rel="noopener">Android Window 机制探索
</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/22/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%AA%E4%BA%BA%E5%91%A8%E6%8A%A5%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/22/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%AA%E4%BA%BA%E5%91%A8%E6%8A%A5%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">如何写好个人周报（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-22 19:37:25" itemprop="dateCreated datePublished" datetime="2019-11-22T19:37:25+08:00">2019-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:17:22" itemprop="dateModified" datetime="2020-02-07T01:17:22+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%96%B9%E6%B3%95%E8%AE%BA/" itemprop="url" rel="index"><span itemprop="name">方法论</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E6%96%B9%E6%B3%95%E8%AE%BA/%E5%9F%BA%E6%9C%AC%E5%8A%9F/" itemprop="url" rel="index"><span itemprop="name">基本功</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是周报"><a href="#什么是周报" class="headerlink" title="什么是周报"></a>什么是周报</h3><ul>
<li>起源：管理者对下属的不了解，不信任。因为不知道你最近在做什么，接下来准备做什么，所以需要一份汇报，而这汇报又比较高频，从而成为了周报</li>
<li>内容：对本周工作的总结和沉淀，对下周工作的计划和安排；同时也可以辅助思考，讨论，困难，失误，经验，成长等更多维度的信息</li>
</ul>
<h3 id="为什么要写周报"><a href="#为什么要写周报" class="headerlink" title="为什么要写周报"></a>为什么要写周报</h3><blockquote>
<p>如果管理者不知道你做了某件事情，相当于你就没有做过这件事情<br>沟通越充分，获得信任感越多<br>管理者掌握信息越全面细致，通常执行力也就越强</p>
</blockquote>
<ul>
<li>个人<ul>
<li>提升自己复盘、思考和规划能力、培养全局观、加强条理性</li>
<li>合理的计划决定时间管理水平，时间管理又决定工作效率的高低</li>
<li>个人与团队之间进行更有效沟通，促成协同与互补</li>
<li>个人与领导高效沟通，获取信任，并寻求资源与帮助</li>
</ul>
</li>
<li>领导<ul>
<li>更高的管理效率：周报是Leader与同学沟通成本最低的一种载体</li>
<li>思想和目标对齐：目标、进展、风险等项目大方面把控</li>
</ul>
</li>
</ul>
<h3 id="周报内容"><a href="#周报内容" class="headerlink" title="周报内容"></a>周报内容</h3><h4 id="本周工作内容"><a href="#本周工作内容" class="headerlink" title="本周工作内容"></a>本周工作内容</h4><p>按项目分类，包含但不限于背景、目标、里程碑|计划、进展、风险&amp;问题，下面对其中几个重要点进行分析</p>
<ul>
<li>目标：量化项目目标指标，遵循SMART原则<ul>
<li>Specific，必须具体</li>
<li>Measurable，必须是可以衡量</li>
<li>Attainable，必须是可以达到的</li>
<li>Relevant，要与其他目标具有一定的相关性</li>
<li>Time-bound，必须具有明确的截止期限</li>
</ul>
</li>
<li>进展 <ul>
<li>细化任务，计划任务量、合理时间分配、明确完成时间点</li>
<li>反馈各个任务执行结果，如完成情况/耗时情况/未达预期的原因/改进方案等 </li>
</ul>
</li>
<li>问题<ul>
<li>维度：人、事、流程、关系等</li>
<li>内容：思考、建议、方案或者Todo、行动</li>
<li>回溯上一周面临的问题是否得到解决，解决方案是否有效，并总结经验</li>
</ul>
</li>
</ul>
<h4 id="下周工作计划"><a href="#下周工作计划" class="headerlink" title="下周工作计划"></a>下周工作计划</h4><ul>
<li>工作内容：做什么？（明确目标和任务）</li>
<li>工作分工：谁来做？（落实责任到人和标准）</li>
<li>工作方法：怎么做？（具体执行方案或者策略）</li>
<li>工作进度：时间点？（任务量、预计投入、完成时间点）</li>
</ul>
<h4 id="本周工作感悟"><a href="#本周工作感悟" class="headerlink" title="本周工作感悟"></a>本周工作感悟</h4><ul>
<li>维度：思考、建议、疑惑、分享等</li>
<li>举例<ul>
<li>工作中遇到问题的提炼，应对方案的分享</li>
<li>工作过程中不同点呈现，创新思考或者亮点的提炼</li>
<li>指标数据的呈现，及差异化分析总结</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/20/Android%E7%B3%BB%E7%BB%9F_WMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/20/Android%E7%B3%BB%E7%BB%9F_WMS%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">Android系统_WMS启动流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-20 21:50:52" itemprop="dateCreated datePublished" datetime="2019-11-20T21:50:52+08:00">2019-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:10:53" itemprop="dateModified" datetime="2020-02-07T01:10:53+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概括"><a href="#图文概括" class="headerlink" title="图文概括"></a>图文概括</h3><h4 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h4><p><img src="https://upload-images.jianshu.io/upload_images/9696036-a6e6f84469e58d99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h4 id="重要成员"><a href="#重要成员" class="headerlink" title="重要成员"></a>重要成员</h4><p><img src="https://upload-images.jianshu.io/upload_images/9696036-726e431873d74004.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li>Session<ul>
<li>WMS的成员变量mSessions保存着所有的Session对象,Session继承于IWindowSession.Stub, 作为Binder服务端</li>
<li>每一个应用进程都有一个唯一的 Session 对象与 WMS 通信</li>
<li>ViewRootImpl 和 WMS 之间的通信就是通过 Session 对象完成的</li>
</ul>
</li>
<li>WindowState<ul>
<li>WMS中，通过mWindowMap（WindowHashMap ）保存所有的WindowState对象</li>
<li>WindowState 中保存了 WMS 对象、WMP 对象、Session 对象和 IWindow对象,一个 WindowState 对象就对应着一个应用进程中的 Window 对象; IWindow -&gt; ViewRootImpl.W extends IWindow.Stub</li>
</ul>
</li>
<li>WindowToken<ul>
<li>WMS成员变量mTokenMap: 保存所有的WindowToken对象; 以IBinder为key,可以是IAppWindowToken或者其他Binder的Bp端;IBinder -&gt; ActivityRecord.Token extends IApplicationToken.Stub</li>
<li>一个 WindowToken 就代表着一个应用组件，应用组件包括：Activity、InputMethod 等。在 WMS 中，会将属于同一 WindowToken 的做统一处理，比如在对窗口进行 ZOrder 排序时，会将属于统一 WindowToken 的排在一起</li>
<li>WindowToken 也具有令牌的作用。应用组件在创建 Window 时都需要提供一个有效的 WindowToken 以表明自己的身份，并且窗口的类型必须与所持有的 WindowToken 类型保持一致。</li>
</ul>
</li>
</ul>
<h3 id="源码分析—启动流程"><a href="#源码分析—启动流程" class="headerlink" title="源码分析—启动流程"></a>源码分析—启动流程</h3><blockquote>
<p>基于API23 </p>
</blockquote>
<h4 id="SystemServer启动WMS"><a href="#SystemServer启动WMS" class="headerlink" title="SystemServer启动WMS"></a>SystemServer启动WMS</h4><ul>
<li>执行WMS的main方法，进行WMS创建及初始化</li>
<li>执行WMS的displayReady方法，初始化显示信息</li>
<li>执行WMS的systemReady方法，通知 WMS 系统的初始化工作完成</li>
</ul>
<p>参考：<a href="https://www.jianshu.com/p/0556e0940115" target="_blank" rel="noopener">Android系统_SystemServer启动流程分析
</a></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;&#x2F; system server 执行启动其它系统服务</span><br><span class="line"> private void startOtherServices() &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 执行 WMS的main方法</span><br><span class="line">    WindowManagerService wm &#x3D; WindowManagerService.main(context, inputManager,</span><br><span class="line">    mFactoryTestMode !&#x3D; FactoryTest.FACTORY_TEST_LOW_LEVEL,</span><br><span class="line">    !mFirstBoot, mOnlyCore);</span><br><span class="line">    </span><br><span class="line">    wm.displayReady(); </span><br><span class="line">    ...</span><br><span class="line">    wm.systemReady(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main方法"><a href="#main方法" class="headerlink" title="main方法"></a>main方法</h4><ul>
<li>WMS为单例模式</li>
<li>WMS的main方法，通过DisplayThread创建了一个WMS单例对象</li>
<li>运行在”android.display”线程，DisplayThread 线程是一个系统前台线程，用于执行一些延时要非常小的关于显示的操作，一般只会在 WindowManager、DisplayManager 和 InputManager 中使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class WindowManagerService extends IWindowManager.Stub</span><br><span class="line">        implements Watchdog.Monitor, WindowManagerPolicy.WindowManagerFuncs &#123;</span><br><span class="line"></span><br><span class="line">    private static WindowManagerService sInstance;</span><br><span class="line">    static WindowManagerService getInstance() &#123;</span><br><span class="line">        return sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static WindowManagerService main(final Context context, final InputManagerService im,</span><br><span class="line">            final boolean haveInputMethods, final boolean showBootMsgs, final boolean onlyCore,</span><br><span class="line">            WindowManagerPolicy policy) &#123;</span><br><span class="line">        &#x2F;&#x2F; &quot;android.display&quot;线程</span><br><span class="line">        DisplayThread.getHandler().runWithScissors(() -&gt;</span><br><span class="line">                sInstance &#x3D; new WindowManagerService(context, im, haveInputMethods, showBootMsgs,</span><br><span class="line">                        onlyCore, policy), 0);</span><br><span class="line">        return sInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><ol>
<li>赋值及初始化成员变量（context、inputManager、policy）等</li>
<li>创建一个 WindowAnimator 对象，用于管理所有窗口的动画</li>
<li>初始化 mPolicy ，具体的实现类是 PhoneWindowManager，WMS 的许多操作都是需要 WMP 规定的，比如：多个窗口的上下顺序，监听屏幕旋转的状态，预处理一些系统按键事件（例如HOME、BACK键等的默认行为就是在这里实现的）</li>
<li>将 WMS 实例对象本身添加到 Watchdog 中，WMS 类实现了 Watchdog.Monitor 接口。Watchdog 用于监控系统的一些关键服务</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">private WindowManagerService(Context context, InputManagerService inputManager, boolean haveInputMethods, boolean showBootMsgs, boolean onlyCore) &#123;</span><br><span class="line">    mContext &#x3D; context;</span><br><span class="line">    mHaveInputMethods &#x3D; haveInputMethods;</span><br><span class="line">    mAllowBootMessages &#x3D; showBootMsgs;</span><br><span class="line">    mOnlyCore &#x3D; onlyCore;</span><br><span class="line">    ...</span><br><span class="line">    mInputManager &#x3D; inputManager; </span><br><span class="line">    mDisplayManagerInternal &#x3D; LocalServices.getService(DisplayManagerInternal.class);</span><br><span class="line">    mDisplaySettings &#x3D; new DisplaySettings();</span><br><span class="line">    mDisplaySettings.readSettingsLocked();</span><br><span class="line"></span><br><span class="line">    LocalServices.addService(WindowManagerPolicy.class, mPolicy);</span><br><span class="line">    mPointerEventDispatcher &#x3D; new PointerEventDispatcher(mInputManager.monitorInput(TAG));</span><br><span class="line"></span><br><span class="line">    mFxSession &#x3D; new SurfaceSession();</span><br><span class="line">    mDisplayManager &#x3D; (DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">    mDisplays &#x3D; mDisplayManager.getDisplays();</span><br><span class="line"></span><br><span class="line">    for (Display display : mDisplays) &#123;</span><br><span class="line">        createDisplayContentLocked(display);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mKeyguardDisableHandler &#x3D; new KeyguardDisableHandler(mContext, mPolicy);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    mAppTransition &#x3D; new AppTransition(context, mH);</span><br><span class="line">    mAppTransition.registerListenerLocked(mActivityManagerAppTransitionNotifier);</span><br><span class="line">    mActivityManager &#x3D; ActivityManagerNative.getDefault();</span><br><span class="line">    ...</span><br><span class="line">    mAnimator &#x3D; new WindowAnimator(this);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    LocalServices.addService(WindowManagerInternal.class, new LocalService());</span><br><span class="line">    &#x2F;&#x2F;初始化策略</span><br><span class="line">    initPolicy();</span><br><span class="line"></span><br><span class="line">    Watchdog.getInstance().addMonitor(this);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="initPolicy"><a href="#initPolicy" class="headerlink" title="initPolicy"></a>initPolicy</h4><ul>
<li>UiThread进行policy的初始化，此过程为同步阻塞过程，运行在android.ui线程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void initPolicy() &#123;</span><br><span class="line">    &#x2F;&#x2F; 切换到 UiThread 执行，运行在&quot;android.ui&quot;线程，runWithScissors会判断当前执行线程，来决定是直接执行还是等待执行</span><br><span class="line">    UiThread.getHandler().runWithScissors(new Runnable() &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">    WindowManagerPolicyThread.set(Thread.currentThread(), Looper.myLooper());</span><br><span class="line">            &#x2F;&#x2F; 初始化</span><br><span class="line">            mPolicy.init(mContext, WindowManagerService.this, WindowManagerService.this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="displayReady"><a href="#displayReady" class="headerlink" title="displayReady"></a>displayReady</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void displayReady() &#123;</span><br><span class="line">    for (Display display : mDisplays) &#123;</span><br><span class="line">        displayReady(display.getDisplayId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized(mWindowMap) &#123;</span><br><span class="line">        final DisplayContent displayContent &#x3D; getDefaultDisplayContentLocked();</span><br><span class="line">        readForcedDisplayPropertiesLocked(displayContent);</span><br><span class="line">        mDisplayReady &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mActivityManager.updateConfiguration(null);</span><br><span class="line"></span><br><span class="line">    synchronized(mWindowMap) &#123;</span><br><span class="line">        mIsTouchDevice &#x3D; mContext.getPackageManager().hasSystemFeature(</span><br><span class="line">                PackageManager.FEATURE_TOUCHSCREEN);</span><br><span class="line">        configureDisplayPolicyLocked(getDefaultDisplayContentLocked());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mActivityManager.updateConfiguration(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="systemReady"><a href="#systemReady" class="headerlink" title="systemReady"></a>systemReady</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void systemReady() &#123;</span><br><span class="line">    mPolicy.systemReady();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public void systemReady() &#123;</span><br><span class="line">    mKeyguardDelegate &#x3D; new KeyguardServiceDelegate(mContext);</span><br><span class="line">    mKeyguardDelegate.onSystemReady();</span><br><span class="line"></span><br><span class="line">    readCameraLensCoverState();</span><br><span class="line">    updateUiMode();</span><br><span class="line">    boolean bindKeyguardNow;</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        updateOrientationListenerLp();</span><br><span class="line">        mSystemReady &#x3D; true;</span><br><span class="line">        </span><br><span class="line">        mHandler.post(new Runnable() &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                updateSettings();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        bindKeyguardNow &#x3D; mDeferBindKeyguard;</span><br><span class="line">        if (bindKeyguardNow) &#123;</span><br><span class="line">            mDeferBindKeyguard &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (bindKeyguardNow) &#123;</span><br><span class="line">        mKeyguardDelegate.bindService(mContext);</span><br><span class="line">        mKeyguardDelegate.onBootCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">    mSystemGestures.systemReady();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="源码分析—重要成员"><a href="#源码分析—重要成员" class="headerlink" title="源码分析—重要成员"></a>源码分析—重要成员</h3><h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><ul>
<li>WMS的成员变量mSessions保存着所有的Session对象,Session继承于IWindowSession.Stub, 作为Binder服务端;</li>
<li>每一个应用进程都有一个唯一的 Session 对象与 WMS 通信</li>
<li>ViewRootImpl 和 WMS 之间的通信就是通过 Session 对象完成的。</li>
</ul>
<h5 id="WMS-mSessions"><a href="#WMS-mSessions" class="headerlink" title="WMS.mSessions"></a>WMS.mSessions</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class WindowManagerService extends IWindowManager.Stub</span><br><span class="line">        implements Watchdog.Monitor, WindowManagerPolicy.WindowManagerFuncs &#123;</span><br><span class="line">        &#x2F;&#x2F; All currently active sessions with clients.</span><br><span class="line">        final ArraySet&lt;Session&gt; mSessions &#x3D; new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public IWindowSession openSession(IWindowSessionCallback callback, IInputMethodClient client,</span><br><span class="line">            IInputContext inputContext) &#123;</span><br><span class="line">            </span><br><span class="line">            Session session &#x3D; new Session(this, callback, client, inputContext);</span><br><span class="line">            return session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class Session extends IWindowSession.Stub</span><br><span class="line">        implements IBinder.DeathRecipient &#123;</span><br><span class="line">    final WindowManagerService mService; &#x2F;&#x2F; 持有WMS</span><br><span class="line">    private int mNumWindow &#x3D; 0; </span><br><span class="line">    </span><br><span class="line">    public Session(WindowManagerService service, IWindowSessionCallback callback,</span><br><span class="line">            IInputMethodClient client, IInputContext inputContext) &#123;</span><br><span class="line">        mService &#x3D; service; &#x2F;&#x2F; 赋值</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 添加</span><br><span class="line">    void windowAddedLocked(String packageName) &#123;</span><br><span class="line">        if (mSurfaceSession &#x3D;&#x3D; null) &#123;</span><br><span class="line">            mService.mSessions.add(this);</span><br><span class="line">        &#125;</span><br><span class="line">        mNumWindow++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 移除</span><br><span class="line">    void windowRemovedLocked() &#123;</span><br><span class="line">        mNumWindow--;</span><br><span class="line">        killSessionLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void killSessionLocked() &#123;</span><br><span class="line">        if (mNumWindow &gt; 0 || !mClientDead) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        mService.mSessions.remove(this);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="WindowState"><a href="#WindowState" class="headerlink" title="WindowState"></a>WindowState</h4><ul>
<li>WMS中，通过mWindowMap（WindowHashMap ）保存所有的WindowState对象</li>
<li>WindowState 中保存了 WMS 对象、WMP 对象、Session 对象和 IWindow对象,一个 WindowState 对象就对应着一个应用进程中的 Window 对象; IWindow -&gt; ViewRootImpl.W extends IWindow.Stub</li>
</ul>
<h5 id="WindowManagerService-addWindowToken"><a href="#WindowManagerService-addWindowToken" class="headerlink" title="WindowManagerService.addWindowToken"></a>WindowManagerService.addWindowToken</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final HashMap&lt;IBinder, WindowToken&gt; mTokenMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">public void addWindowToken(IBinder token, int type) &#123;</span><br><span class="line">   synchronized(mWindowMap) &#123;</span><br><span class="line">       WindowToken wtoken &#x3D; mTokenMap.get(token);</span><br><span class="line">       wtoken &#x3D; new WindowToken(this, token, type, true);</span><br><span class="line">       mTokenMap.put(token, wtoken);</span><br><span class="line">       if (type &#x3D;&#x3D; TYPE_WALLPAPER) &#123;</span><br><span class="line">           mWallpaperTokens.add(wtoken);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class WindowState extends WindowContainer&lt;WindowState&gt; implements WindowManagerPolicy.WindowState &#123;</span><br><span class="line">    final WindowManagerService mService; &#x2F;&#x2F; WMS</span><br><span class="line">    final WindowManagerPolicy mPolicy; &#x2F;&#x2F; WMP</span><br><span class="line">    final Context mContext; &#x2F;&#x2F;ctx</span><br><span class="line">    final Session mSession; &#x2F;&#x2F; session </span><br><span class="line">    final IWindow mClient;  &#x2F;&#x2F; 应用进程中的 Window 对象</span><br><span class="line"></span><br><span class="line">    WindowState(WindowManagerService service, Session s, IWindow c, WindowToken token,</span><br><span class="line">           WindowState parentWindow, int appOp, int seq, WindowManager.LayoutParams a,</span><br><span class="line">           int viewVisibility, int ownerId, boolean ownerCanAddInternalSystemWindow) &#123;</span><br><span class="line">        mService &#x3D; service;</span><br><span class="line">        mSession &#x3D; s;</span><br><span class="line">        mClient &#x3D; c;</span><br><span class="line">        mAppOp &#x3D; appOp;</span><br><span class="line">        mToken &#x3D; token;</span><br><span class="line">        mAppToken &#x3D; mToken.asAppWindowToken();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void attach() &#123;</span><br><span class="line">        mSession.windowAddedLocked(mAttrs.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; IWindow mClient 就是 ViewRootImpl 中的 final W mWindow 成员</span><br><span class="line">public final class ViewRootImpl implements ViewParent,</span><br><span class="line">        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks &#123;</span><br><span class="line">    final W mWindow;</span><br><span class="line"></span><br><span class="line">    static class W extends IWindow.Stub &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="WindowToken"><a href="#WindowToken" class="headerlink" title="WindowToken"></a>WindowToken</h4><ul>
<li>WMS成员变量mTokenMap: 保存所有的WindowToken对象; 以IBinder为key,可以是IAppWindowToken或者其他Binder的Bp端;IBinder -&gt; ActivityRecord.Token extends IApplicationToken.Stub</li>
<li>一个 WindowToken 就代表着一个应用组件，应用组件包括：Activity、InputMethod 等。在 WMS 中，会将属于同一 WindowToken 的做统一处理，比如在对窗口进行 ZOrder 排序时，会将属于统一 WindowToken 的排在一起</li>
<li>WindowToken 也具有令牌的作用。应用组件在创建 Window 时都需要提供一个有效的 WindowToken 以表明自己的身份，并且窗口的类型必须与所持有的 WindowToken 类型保持一致。</li>
</ul>
<h5 id="WMS-mTokenMap相关"><a href="#WMS-mTokenMap相关" class="headerlink" title="WMS.mTokenMap相关"></a>WMS.mTokenMap相关</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">final HashMap&lt;IBinder, WindowToken&gt; mTokenMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">public void addWindowToken(IBinder token, int type) &#123;</span><br><span class="line">     synchronized(mWindowMap) &#123;</span><br><span class="line">       WindowToken wtoken &#x3D; mTokenMap.get(token);</span><br><span class="line">       wtoken &#x3D; new WindowToken(this, token, type, true);</span><br><span class="line">       mTokenMap.put(token, wtoken);</span><br><span class="line">       if (type &#x3D;&#x3D; TYPE_WALLPAPER) &#123;</span><br><span class="line">           mWallpaperTokens.add(wtoken);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a><br>参考：<br><a href="http://gityuan.com/2017/01/08/windowmanger/" target="_blank" rel="noopener">WMS—启动过程</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/20/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.draw%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/20/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.draw%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Android图形系统—View.draw解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-20 20:19:41" itemprop="dateCreated datePublished" datetime="2019-11-20T20:19:41+08:00">2019-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:10:44" itemprop="dateModified" datetime="2020-02-07T01:10:44+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概括"><a href="#图文概括" class="headerlink" title="图文概括"></a>图文概括</h3><h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ol>
<li>绘制背景</li>
<li>绘制内容</li>
<li>分发子View绘制</li>
<li>绘制装饰</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-0bfd5198cdefa19c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="View-draw"><a href="#View-draw" class="headerlink" title="View.draw"></a>View.draw</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">public void draw(Canvas canvas) &#123;</span><br><span class="line">    .... </span><br><span class="line">    &#x2F;&#x2F; 1. 绘制本身View背景</span><br><span class="line">    if (!dirtyOpaque) &#123;</span><br><span class="line">        drawBackground(canvas);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</span><br><span class="line">        &#x2F;&#x2F; Step 3, draw the content</span><br><span class="line">        &#x2F;&#x2F; 2. 绘制内容，默认空实现 需复写</span><br><span class="line">        if (!dirtyOpaque) onDraw(canvas);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 3. 绘制 children </span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        drawAutofilledHighlight(canvas);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 4. 分发Draw （单一View空实现，ViewGroup见下面分析）</span><br><span class="line">        if (mOverlay !&#x3D; null &amp;&amp; !mOverlay.isEmpty()) &#123;</span><br><span class="line">            mOverlay.getOverlayView().dispatchDraw(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        &#x2F;&#x2F; 5. 绘制装饰 (前景色，滚动条)</span><br><span class="line">        onDrawForeground(canvas);</span><br><span class="line"></span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;绘制背景</span><br><span class="line">private void drawBackground(Canvas canvas) &#123;</span><br><span class="line">    final Drawable background &#x3D; mBackground;</span><br><span class="line">    if (background &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 根据在 layout 过程中获取的 View 的位置参数，来设置背景的边界</span><br><span class="line">    setBackgroundBounds();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 先尝试用HWUI绘制</span><br><span class="line">    if (canvas.isHardwareAccelerated() &amp;&amp; mAttachInfo !&#x3D; null</span><br><span class="line">            &amp;&amp; mAttachInfo.mThreadedRenderer !&#x3D; null) &#123;</span><br><span class="line">        mBackgroundRenderNode &#x3D; getDrawableRenderNode(background, mBackgroundRenderNode);</span><br><span class="line"></span><br><span class="line">        final RenderNode renderNode &#x3D; mBackgroundRenderNode;</span><br><span class="line">        if (renderNode !&#x3D; null &amp;&amp; renderNode.isValid()) &#123;</span><br><span class="line">            setBackgroundRenderNodeProperties(renderNode);</span><br><span class="line">            ((DisplayListCanvas) canvas).drawRenderNode(renderNode);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final int scrollX &#x3D; mScrollX;</span><br><span class="line">    final int scrollY &#x3D; mScrollY;</span><br><span class="line">    if ((scrollX | scrollY) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        &#x2F;&#x2F;调用 Drawable 的 draw 方法来进行背景的绘制</span><br><span class="line">        background.draw(canvas);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; 若 mScrollX 和 mScrollY 有值，则对 canvas 的坐标进行偏移平移画布</span><br><span class="line">        canvas.translate(scrollX, scrollY);</span><br><span class="line">        &#x2F;&#x2F;调用 Drawable 的 draw 方法来进行背景的绘制</span><br><span class="line">        background.draw(canvas);</span><br><span class="line">        canvas.translate(-scrollX, -scrollY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 绘制View本身内容，空实现，子类必须复写</span><br><span class="line">protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 单一View无子View，空实现</span><br><span class="line">protected void dispatchDraw(Canvas canvas) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void onDrawForeground(Canvas canvas) &#123;</span><br><span class="line">    &#x2F;&#x2F;绘制指示器</span><br><span class="line">    onDrawScrollIndicators(canvas);</span><br><span class="line">    &#x2F;&#x2F;绘制滚动条</span><br><span class="line">    onDrawScrollBars(canvas);</span><br><span class="line"></span><br><span class="line">    final Drawable foreground &#x3D; mForegroundInfo !&#x3D; null ? mForegroundInfo.mDrawable : null;</span><br><span class="line">    if (foreground !&#x3D; null) &#123;</span><br><span class="line">        if (mForegroundInfo.mBoundsChanged) &#123;</span><br><span class="line">            mForegroundInfo.mBoundsChanged &#x3D; false;</span><br><span class="line">            final Rect selfBounds &#x3D; mForegroundInfo.mSelfBounds;</span><br><span class="line">            final Rect overlayBounds &#x3D; mForegroundInfo.mOverlayBounds;</span><br><span class="line"></span><br><span class="line">            if (mForegroundInfo.mInsidePadding) &#123;</span><br><span class="line">                selfBounds.set(0, 0, getWidth(), getHeight());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                selfBounds.set(getPaddingLeft(), getPaddingTop(),</span><br><span class="line">                        getWidth() - getPaddingRight(), getHeight() - getPaddingBottom());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            final int ld &#x3D; getLayoutDirection();</span><br><span class="line">            Gravity.apply(mForegroundInfo.mGravity, foreground.getIntrinsicWidth(),</span><br><span class="line">                    foreground.getIntrinsicHeight(), selfBounds, overlayBounds, ld);</span><br><span class="line">            foreground.setBounds(overlayBounds);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;调用 Drawable 的 draw 方法，绘制前景色</span><br><span class="line">        foreground.draw(canvas);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ViewGroup-draw"><a href="#ViewGroup-draw" class="headerlink" title="ViewGroup.draw"></a>ViewGroup.draw</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public void draw(Canvas canvas) &#123;</span><br><span class="line">    &#x2F;&#x2F; 调用View.draw 方法</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected void dispatchDraw(Canvas canvas) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 1. 遍历子View</span><br><span class="line">    final int childrenCount &#x3D; mChildrenCount;</span><br><span class="line">    ...</span><br><span class="line">    for (int i &#x3D; 0; i &lt; childrenCount; i++) &#123;</span><br><span class="line">        while (transientIndex &gt;&#x3D; 0 &amp;&amp; mTransientIndices.get(transientIndex) &#x3D;&#x3D; i) &#123;</span><br><span class="line">            final View transientChild &#x3D; mTransientViews.get(transientIndex);</span><br><span class="line">            if ((transientChild.mViewFlags &amp; VISIBILITY_MASK) &#x3D;&#x3D; VISIBLE ||</span><br><span class="line">                    transientChild.getAnimation() !&#x3D; null) &#123;</span><br><span class="line">                more |&#x3D; drawChild(canvas, transientChild, drawingTime);</span><br><span class="line">            &#125;</span><br><span class="line">            transientIndex++;</span><br><span class="line">            if (transientIndex &gt;&#x3D; transientCount) &#123;</span><br><span class="line">                transientIndex &#x3D; -1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final int childIndex &#x3D; getAndVerifyPreorderedIndex(childrenCount, i, customOrder);</span><br><span class="line">        final View child &#x3D; getAndVerifyPreorderedView(preorderedList, children, childIndex);</span><br><span class="line">        if ((child.mViewFlags &amp; VISIBILITY_MASK) &#x3D;&#x3D; VISIBLE || child.getAnimation() !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 调用 drawChild 方法，进行子元素绘制</span><br><span class="line">            more |&#x3D; drawChild(canvas, child, drawingTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line">-</span><br></pre></td></tr></table></figure>

<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/19/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.layout%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/19/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.layout%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Android图形系统—View.layout解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-19 20:44:27" itemprop="dateCreated datePublished" datetime="2019-11-19T20:44:27+08:00">2019-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:10:36" itemprop="dateModified" datetime="2020-02-07T01:10:36+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概括"><a href="#图文概括" class="headerlink" title="图文概括"></a>图文概括</h3><ol>
<li>单一View通过layout方法确定位置，ViewGroup子类通过重写抽象onLayout方法来实现子视图以及自己的位置分配逻辑</li>
<li>getWidth|getHeight与getMeasuredWidth|getMeasureHeight区别</li>
</ol>
<table>
<thead>
<tr>
<th>方法</th>
<th>概念</th>
<th>时机</th>
<th>场景</th>
</tr>
</thead>
<tbody><tr>
<td>getMeasuredWidth和Height</td>
<td>测量的宽和高</td>
<td>measure过程</td>
<td>onMeasure使用</td>
</tr>
<tr>
<td>getWidth和Height</td>
<td>计算的宽和高</td>
<td>layout过程</td>
<td>onLayout使用</td>
</tr>
</tbody></table>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-0ce23ae06edca160.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/9696036-4b862fec211de964.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="View-measure过程"><a href="#View-measure过程" class="headerlink" title="View.measure过程"></a>View.measure过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 计算View的四个顶点为孩子（left、top、right、bottom）</span><br><span class="line">public void layout(int l, int t, int r, int b) &#123;</span><br><span class="line">    &#x2F;&#x2F; 判断是否需要重新测量</span><br><span class="line">    if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) !&#x3D; 0) &#123;</span><br><span class="line">      onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</span><br><span class="line">      mPrivateFlags3 &amp;&#x3D; ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 保存上一次View的四个位置</span><br><span class="line">    int oldL &#x3D; mLeft;</span><br><span class="line">    int oldT &#x3D; mTop;</span><br><span class="line">    int oldB &#x3D; mBottom;</span><br><span class="line">    int oldR &#x3D; mRight;</span><br><span class="line">    &#x2F;&#x2F; 设置当前视图View的l、t、r、b位置，及判断布局是否有改变</span><br><span class="line">    boolean changed &#x3D; isLayoutModeOptical(mParent) ?</span><br><span class="line">          setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</span><br><span class="line">    &#x2F;&#x2F; View大小 或者 位置发生变化 则重新布局View</span><br><span class="line">    if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) &#x3D;&#x3D; PFLAG_LAYOUT_REQUIRED) &#123;</span><br><span class="line">        &#x2F;&#x2F; 1. 对于单一View，onLayout是一个空实现</span><br><span class="line">        &#x2F;&#x2F; 2. 对于ViewGroup，因为位置的确定与布局有关，所以onLayout是一个抽象方法，需要重写实现</span><br><span class="line">        onLayout(changed, l, t, r, b);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   ...    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 通过传入的4个顶点位置设置View的四个顶点位置 ，返回位置是否变化</span><br><span class="line">protected boolean setFrame(int left, int top, int right, int bottom) &#123;</span><br><span class="line">    boolean changed &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F; 是否改变</span><br><span class="line">    if (mLeft !&#x3D; left || mRight !&#x3D; right || mTop !&#x3D; top || mBottom !&#x3D; bottom) &#123;</span><br><span class="line">      changed &#x3D; true;</span><br><span class="line">    </span><br><span class="line">      &#x2F;&#x2F; Remember our drawn bit</span><br><span class="line">      int drawn &#x3D; mPrivateFlags &amp; PFLAG_DRAWN;</span><br><span class="line">    </span><br><span class="line">      int oldWidth &#x3D; mRight - mLeft;</span><br><span class="line">      int oldHeight &#x3D; mBottom - mTop;</span><br><span class="line">      int newWidth &#x3D; right - left;</span><br><span class="line">      int newHeight &#x3D; bottom - top;</span><br><span class="line">      boolean sizeChanged &#x3D; (newWidth !&#x3D; oldWidth) || (newHeight !&#x3D; oldHeight);</span><br><span class="line">    </span><br><span class="line">      &#x2F;&#x2F; 位置变化，执行invalidate</span><br><span class="line">      invalidate(sizeChanged);</span><br><span class="line">      &#x2F;&#x2F; 设置新的顶点位置</span><br><span class="line">      mLeft &#x3D; left;</span><br><span class="line">      mTop &#x3D; top;</span><br><span class="line">      mRight &#x3D; right;</span><br><span class="line">      mBottom &#x3D; bottom;</span><br><span class="line">      mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);</span><br><span class="line">      ...    </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return changed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 单一View在layout已经确定了位置，所以onLayout空实现</span><br><span class="line">protected void onLayout(boolean changed, int left, int top, int right, int bottom) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ViewGroup-measure"><a href="#ViewGroup-measure" class="headerlink" title="ViewGroup.measure"></a>ViewGroup.measure</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; measure过程调用的View.measure，不同在于onLayout</span><br><span class="line">    @Override</span><br><span class="line">public final void layout(int l, int t, int r, int b) &#123;</span><br><span class="line">   if (!mSuppressLayout &amp;&amp; (mTransition &#x3D;&#x3D; null || !mTransition.isChangingLayout())) &#123;</span><br><span class="line">       if (mTransition !&#x3D; null) &#123;</span><br><span class="line">           mTransition.layoutChange(this);</span><br><span class="line">       &#125;</span><br><span class="line">       super.layout(l, t, r, b);</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">       &#x2F;&#x2F; record the fact that we noop&#39;d it; request layout when transition finishes</span><br><span class="line">       mLayoutCalledWhileSuppressed &#x3D; true;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 抽象方法，子类需要实现以实现child的layout计算</span><br><span class="line">protected abstract void onLayout(boolean changed,</span><br><span class="line">       int l, int t, int r, int b);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 大体过程</span><br><span class="line">protected void onLayout(boolean changed,</span><br><span class="line">       int l, int t, int r, int b)&#123;</span><br><span class="line">    for (int i&#x3D;0; i&lt;getChildCount(); i++) &#123;</span><br><span class="line">       View child &#x3D; getChildAt(i);  </span><br><span class="line">       &#x2F;&#x2F; 计算子View的测量宽高</span><br><span class="line">       &#x2F;&#x2F; 执行child的layout方法，child.layout </span><br><span class="line">    &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/18/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F-View%E4%B9%8BLinearLayout.onMeasure%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/18/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F-View%E4%B9%8BLinearLayout.onMeasure%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Android图形系统-View之LinearLayout.onMeasure分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-18 14:35:32" itemprop="dateCreated datePublished" datetime="2019-11-18T14:35:32+08:00">2019-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:10:21" itemprop="dateModified" datetime="2020-02-07T01:10:21+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概括"><a href="#图文概括" class="headerlink" title="图文概括"></a>图文概括</h3><p><strong>总结</strong></p>
<ol>
<li>【父非EXACTLY &amp; 子控件有weight并且指定高度为0】 则会执行二次测量方法</li>
<li>【不满足1条件 &amp; weight&gt;0】的控件因为没有跳过第一次测量，而在第二次测量方法中也会进行测量</li>
<li>【父非EXACTLY &amp; 子height未指定0 】则weight属性不生效</li>
</ol>
<p><strong>流程</strong><br><img src="https://upload-images.jianshu.io/upload_images/9696036-f6bec68f9afc5729.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><blockquote>
<p>基于API23分析</p>
</blockquote>
<h4 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">   if (mOrientation &#x3D;&#x3D; VERTICAL) &#123;</span><br><span class="line">       measureVertical(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">       measureHorizontal(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void measureVertical(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 变量声明</span><br><span class="line">    &#x2F;&#x2F; 第一次测量，循环测量（非EXACTLY &amp; lp.height&#x3D;&#x3D;0 &amp; lp.weight&gt;0,父不定高且子高度为0还有权重）</span><br><span class="line">    &#x2F;&#x2F; 忽略，useLargestChild&#x3D;true下的测量</span><br><span class="line">    &#x2F;&#x2F; 第二次测量 （weight相关）</span><br><span class="line">    &#x2F;&#x2F; 设置宽高值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">void measureVertical(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 变量声明</span><br><span class="line">    &#x2F;&#x2F; 成员变量，核心目的，求总高度</span><br><span class="line">    mTotalLength &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 记录子空间中最大宽度</span><br><span class="line">    int maxWidth &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 子控件的测量状态，会在遍历子控件测量的时候通过combineMeasuredStates来合并上一个子控件测量状态与当前遍历到的子控件的测量状态，采取的是按位相或</span><br><span class="line">    int childState &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; layout_weight&lt;&#x3D;0的子控件最大宽度</span><br><span class="line">    int alternativeMaxWidth &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; layout_weight&gt;0的子控件最大宽度</span><br><span class="line">    int weightedMaxWidth &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; 以上两个最大宽度跟上面的maxWidth最大的区别在于matchWidthLocally这个参数</span><br><span class="line">    &#x2F;&#x2F; 当matchWidthLocally为真，那么以下两个变量只会跟当前子控件的左右margin和相比较取大值</span><br><span class="line">    &#x2F;&#x2F; 否则，则跟maxWidth的计算方法一样</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 是否子控件全是match_parent的标志位，用于判断是否需要重新测量</span><br><span class="line">    boolean allFillParent &#x3D; true;</span><br><span class="line">    &#x2F;&#x2F; 所有子控件的weight之和</span><br><span class="line">    float totalWeight &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 子控件数目（不含孙及以下控件）</span><br><span class="line">    final int count &#x3D; getVirtualChildCount();</span><br><span class="line">    &#x2F;&#x2F; 测量模式</span><br><span class="line">    final int widthMode &#x3D; MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">    final int heightMode &#x3D; MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">    &#x2F;&#x2F; 当子控件为match_parent的时候，该值为ture，同时判定的还有上面所说的matchWidthLocally，这个变量决定了子控件的测量是父控件干预还是填充父控件（剩余的空白位置）。</span><br><span class="line">    boolean matchWidth &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F; 是否跳过第一次测量</span><br><span class="line">    boolean skippedMeasure &#x3D; false;</span><br><span class="line">    </span><br><span class="line">    final int baselineChildIndex &#x3D; mBaselineAlignedChildIndex;        </span><br><span class="line">    final boolean useLargestChild &#x3D; mUseLargestChild;</span><br><span class="line">    </span><br><span class="line">    int largestChildHeight &#x3D; Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第一次测量"><a href="#第一次测量" class="headerlink" title="第一次测量"></a>第一次测量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">void measureVertical(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 第一次测量</span><br><span class="line">    &#x2F;&#x2F; See how tall everyone is. Also remember max width.</span><br><span class="line">    for (int i &#x3D; 0; i &lt; count; ++i) &#123;</span><br><span class="line">        final View child &#x3D; getVirtualChildAt(i);</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        &#x2F;&#x2F; 添加 Divider高度</span><br><span class="line">        if (hasDividerBeforeChildAt(i)) &#123;</span><br><span class="line">         mTotalLength +&#x3D; mDividerHeight;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        LinearLayout.LayoutParams lp &#x3D; (LinearLayout.LayoutParams) child.getLayoutParams();</span><br><span class="line">        &#x2F;&#x2F; 总weight 添加weight</span><br><span class="line">        totalWeight +&#x3D; lp.weight;</span><br><span class="line">        </span><br><span class="line">        if (heightMode &#x3D;&#x3D; MeasureSpec.EXACTLY &amp;&amp; lp.height &#x3D;&#x3D; 0 &amp;&amp; lp.weight &gt; 0) &#123;</span><br><span class="line">           &#x2F;&#x2F; EXACTLY 且 高度为0 且 weight&gt;0 则先跳过该控件的测量</span><br><span class="line">           final int totalLength &#x3D; mTotalLength;</span><br><span class="line">           mTotalLength &#x3D; Math.max(totalLength, totalLength + lp.topMargin + lp.bottomMargin);</span><br><span class="line">           skippedMeasure &#x3D; true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            int oldHeight &#x3D; Integer.MIN_VALUE;</span><br><span class="line">               </span><br><span class="line">            if (lp.height &#x3D;&#x3D; 0 &amp;&amp; lp.weight &gt; 0) &#123;</span><br><span class="line">                &#x2F;&#x2F; 此条件下，防止height为0</span><br><span class="line">                oldHeight &#x3D; 0;</span><br><span class="line">                lp.height &#x3D; LayoutParams.WRAP_CONTENT;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            &#x2F;&#x2F; 测量child（已经使用的height通过padding实现剔除）</span><br><span class="line">            measureChildBeforeLayout(</span><br><span class="line">                 child, i, widthMeasureSpec, 0, heightMeasureSpec,</span><br><span class="line">                 totalWeight &#x3D;&#x3D; 0 ? mTotalLength : 0);</span><br><span class="line">        </span><br><span class="line">            &#x2F;&#x2F; ...</span><br><span class="line">            final int totalLength &#x3D; mTotalLength;</span><br><span class="line">            mTotalLength &#x3D; Math.max(totalLength, totalLength + childHeight + lp.topMargin +</span><br><span class="line">                 lp.bottomMargin + getNextLocationOffset(child));</span><br><span class="line">       </span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 计算 宽度 和最大宽度等</span><br><span class="line">        &#x2F;&#x2F; ...</span><br><span class="line">    </span><br><span class="line">        i +&#x3D; getChildrenSkipCount(child, i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="调用子测量方法"><a href="#调用子测量方法" class="headerlink" title="调用子测量方法"></a>调用子测量方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void measureChildBeforeLayout(View child, int childIndex,</span><br><span class="line">       int widthMeasureSpec, int totalWidth, int heightMeasureSpec,</span><br><span class="line">       int totalHeight) &#123;</span><br><span class="line">    measureChildWithMargins(child, widthMeasureSpec, totalWidth,</span><br><span class="line">      heightMeasureSpec, totalHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected void measureChildWithMargins(View child,</span><br><span class="line">       int parentWidthMeasureSpec, int widthUsed,</span><br><span class="line">       int parentHeightMeasureSpec, int heightUsed) &#123;</span><br><span class="line">    final MarginLayoutParams lp &#x3D; (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line">    &#x2F;&#x2F; child测量时，会将已经用过的height和weight当作measure的padding来剔除</span><br><span class="line">    final int childWidthMeasureSpec &#x3D; getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">          mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</span><br><span class="line">                  + widthUsed, lp.width);</span><br><span class="line">    final int childHeightMeasureSpec &#x3D; getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">          mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</span><br><span class="line">                  + heightUsed, lp.height);</span><br><span class="line">    </span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="useLargestChild相关测量"><a href="#useLargestChild相关测量" class="headerlink" title="useLargestChild相关测量"></a>useLargestChild相关测量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void measureVertical(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 下面的这一段代码主要是为useLargestChild属性服务的，忽略</span><br><span class="line">    if (mTotalLength &gt; 0 &amp;&amp; hasDividerBeforeChildAt(count)) &#123;</span><br><span class="line">      mTotalLength +&#x3D; mDividerHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (useLargestChild &amp;&amp;</span><br><span class="line">          (heightMode &#x3D;&#x3D; MeasureSpec.AT_MOST || heightMode &#x3D;&#x3D; MeasureSpec.UNSPECIFIED)) &#123;</span><br><span class="line">      mTotalLength &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">      for (int i &#x3D; 0; i &lt; count; ++i) &#123;</span><br><span class="line">          final View child &#x3D; getVirtualChildAt(i);</span><br><span class="line">    </span><br><span class="line">          if (child &#x3D;&#x3D; null) &#123;</span><br><span class="line">              mTotalLength +&#x3D; measureNullChild(i);</span><br><span class="line">              continue;</span><br><span class="line">          &#125;</span><br><span class="line">    </span><br><span class="line">          if (child.getVisibility() &#x3D;&#x3D; GONE) &#123;</span><br><span class="line">              i +&#x3D; getChildrenSkipCount(child, i);</span><br><span class="line">              continue;</span><br><span class="line">          &#125;</span><br><span class="line">    </span><br><span class="line">          final LinearLayout.LayoutParams lp &#x3D; (LinearLayout.LayoutParams)</span><br><span class="line">                  child.getLayoutParams();</span><br><span class="line">          &#x2F;&#x2F; Account for negative margins</span><br><span class="line">          final int totalLength &#x3D; mTotalLength;</span><br><span class="line">          mTotalLength &#x3D; Math.max(totalLength, totalLength + largestChildHeight +</span><br><span class="line">                  lp.topMargin + lp.bottomMargin + getNextLocationOffset(child));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">       </span><br><span class="line">    &#x2F;&#x2F; Add in our padding</span><br><span class="line">    mTotalLength +&#x3D; mPaddingTop + mPaddingBottom;</span><br><span class="line">    </span><br><span class="line">    int heightSize &#x3D; mTotalLength;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Check against our minimum height</span><br><span class="line">    heightSize &#x3D; Math.max(heightSize, getSuggestedMinimumHeight());</span><br><span class="line">       </span><br><span class="line">    &#x2F;&#x2F; Reconcile our calculated size with the heightMeasureSpec</span><br><span class="line">    int heightSizeAndState &#x3D; resolveSizeAndState(heightSize, heightMeasureSpec, 0);</span><br><span class="line">    heightSize &#x3D; heightSizeAndState &amp; MEASURED_SIZE_MASK;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="第二次测量"><a href="#第二次测量" class="headerlink" title="第二次测量"></a>第二次测量</h4><p>⚠️ <strong>weight</strong></p>
<ol>
<li>【父非EXACTLY &amp; 子控件有weight并且指定高度为0】 则会执行二次测量方法</li>
<li>【不满足1条件 &amp; weight&gt;0】的控件因为没有跳过第一次测量，而在第二次测量方法中也会进行测量</li>
<li>【父非EXACTLY &amp; 子height未制定0 则weight属性不生效】</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">公式：</span><br><span class="line">第一次测量：mTotalLength &#x3D; (是否跳过第一次测量) ？ 子.h ：0 </span><br><span class="line">剩余高度： delta &#x3D; heightSize - mTotalLength </span><br><span class="line">分配子高度： share &#x3D; (int) (childExtra * delta &#x2F; weightSum) </span><br><span class="line">剩余权重： weightSum -&#x3D; childExtra</span><br><span class="line">剩余分配高度：  delta -&#x3D; share </span><br><span class="line">子高度： childHeight &#x3D; child.getMeasuredHeight() + share</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line">假设： LinearLayout.h &#x3D; 100 , A.w : B.w &#x3D; 2 :8 (权重)</span><br><span class="line">结果： 子控件设置不同的height，结果如下（-1 &#x3D; match_parent）</span><br><span class="line"></span><br><span class="line">|  | A.h&#x3D;0 | B.h&#x3D;0 | A.h&#x3D;-1 | B.h&#x3D;-1 |</span><br><span class="line">| --- | --- | --- | --- | --- |</span><br><span class="line">| mTotalLength | 0 | 0 | 200 | 200 |</span><br><span class="line">| delta | 100 | 80  | -100 | -80 |</span><br><span class="line">| share | 20 | 80 | -20 | -80 |</span><br><span class="line">| delta | 80 | 0 | -80 | 0 |</span><br><span class="line">| childHeight | 20 | 80 | 80 | 20 |</span><br></pre></td></tr></table></figure>
<p>void measureVertical(int widthMeasureSpec, int heightMeasureSpec) {<br>    // 计算剩余高度<br>    int delta = heightSize - mTotalLength;<br>    // 上面skippedMeasure为true，剩余高度!=0 ，且totalWeight&gt;0<br>    // 有weight的会测量两次，测量两次的控件是上面没有跳过测量的控件而跳过测量的控件这里进行测量（父非EXACTLY且子高度为0还有权重）<br>    if (skippedMeasure || delta != 0 &amp;&amp; totalWeight &gt; 0.0f) {<br>        // 限定weight总和范围，如果设置过weighSum范围，那么子控件的weight为设置的weight<br>      float weightSum = mWeightSum &gt; 0.0f ? mWeightSum : totalWeight;</p>
<pre><code>mTotalLength = 0;

for (int i = 0; i &lt; count; ++i) {
    final View child = getVirtualChildAt(i);

    if (child.getVisibility() == View.GONE) {
        continue;
    }

    LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams();

    float childExtra = lp.weight;
    // weight  &gt; 0 的控件进行测量
    if (childExtra &gt; 0) {
      // 公式 = 剩余高度*（子控件的weight/weightSum）
      int share = (int) (childExtra * delta / weightSum);
      // weightSum计余
      weightSum -= childExtra;
      // 剩余高度
      delta -= share;
      // 计算child 的测量规格    
      final int childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,
             mPaddingLeft + mPaddingRight +
                     lp.leftMargin + lp.rightMargin, lp.width);
      // 如果child height没有指定0（wrap或者match） 且非 EXACTLY
      if ((lp.height != 0) || (heightMode != MeasureSpec.EXACTLY)) {
          // childHeight = 测量高度+分配高度
          // ⚠️ 此处share为 负数
          int childHeight = child.getMeasuredHeight() + share;
          if (childHeight &lt; 0) {
              childHeight = 0;
          }
          // child测量
          child.measure(childWidthMeasureSpec,
                  MeasureSpec.makeMeasureSpec(childHeight, MeasureSpec.EXACTLY));
      } else {
          // 用分配高度进行child 测量
          child.measure(childWidthMeasureSpec,
             MeasureSpec.makeMeasureSpec(share &gt; 0 ? share : 0,</code></pre><p>MeasureSpec.EXACTLY));<br>              }</p>
<pre><code>          childState = combineMeasuredStates(childState, child.getMeasuredState()
                  &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT));
      }

    // 计算宽度 
    // ...  省略
  }


  mTotalLength += mPaddingTop + mPaddingBottom;

}  else {
    // 没有weight，只有usrLargestChild为true的计算，省略 
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#### 设置宽高值</span><br></pre></td></tr></table></figure>
<p>void measureVertical(int widthMeasureSpec, int heightMeasureSpec) {<br>    // 设置宽高<br>    if (!allFillParent &amp;&amp; widthMode != MeasureSpec.EXACTLY) {<br>      maxWidth = alternativeMaxWidth;<br>    }</p>
<pre><code>maxWidth += mPaddingLeft + mPaddingRight;

// Check against our minimum width
maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());
// 设置 LinearLayout的宽、高值
setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),
      heightSizeAndState);

if (matchWidth) {
  forceUniformWidth(count, heightMeasureSpec);
}   </code></pre><p>}</p>
<pre><code>
-------

推荐阅读：[图形系统总结](https://www.jianshu.com/p/238eb0a17760)
</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/17/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.measure%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/17/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F%E2%80%94View.measure%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Android图形系统—View.measure解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-17 20:44:00" itemprop="dateCreated datePublished" datetime="2019-11-17T20:44:00+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:09:47" itemprop="dateModified" datetime="2020-02-07T01:09:47+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概览"><a href="#图文概览" class="headerlink" title="图文概览"></a>图文概览</h3><h4 id="View测量流程"><a href="#View测量流程" class="headerlink" title="View测量流程"></a>View测量流程</h4><ol>
<li>measure<ul>
<li>性质：final方法，View测量初始方法  </li>
<li>作用：基本逻辑计算，是否重新测量，调用onMeasure，缓存测量规格</li>
</ul>
</li>
<li>onMeasure <ul>
<li>性质：测量方法，子类可复写实现自己的测量方式</li>
<li>作用：进行测量规格计算，调用getDefaultSize和setMeasureDimension</li>
</ul>
</li>
<li>getDefaultSize<ul>
<li>作用：根据View的测量规格计算宽/高值</li>
</ul>
</li>
<li>setMeasureDimension<ul>
<li>作用：存储测量后的宽/高值</li>
</ul>
</li>
</ol>
<p>View测量规格参考：<a href="https://www.jianshu.com/p/66eb92cca405" target="_blank" rel="noopener">View.MeasureSpec分析</a></p>
<h4 id="ViewGroup测量大概流程"><a href="#ViewGroup测量大概流程" class="headerlink" title="ViewGroup测量大概流程"></a>ViewGroup测量大概流程</h4><p><img src="media/View.Measure.png" alt="View.Measure"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="View-measure流程"><a href="#View-measure流程" class="headerlink" title="View.measure流程"></a>View.measure流程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; view measure入口， final类型</span><br><span class="line">public final void measure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 是否需要再次计算等计算</span><br><span class="line">    ... </span><br><span class="line">    if (cacheIndex &lt; 0 || sIgnoreMeasureCache) &#123;   </span><br><span class="line">        &#x2F;&#x2F; 计算视图大小</span><br><span class="line">        onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">        mPrivateFlags3 &amp;&#x3D; ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">    &#125;else &#123; </span><br><span class="line">        setMeasuredDimensionRaw((int) (value &gt;&gt; 32), (int) value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 存储测量后的View宽 &#x2F; 高</span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">          getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; View的宽度为mMinWidth和mBackground.getMinimumWidth()中的最大值,高度类似</span><br><span class="line">protected int getSuggestedMinimumWidth() &#123;</span><br><span class="line">    return (mBackground &#x3D;&#x3D; null) ? mMinWidth : max(mMinWidth,mBackground.getMinimumWidth());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 根据View宽&#x2F;高的测量规格计算View的宽&#x2F;高值</span><br><span class="line">public static int getDefaultSize(int size, int measureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; 设置默认大小</span><br><span class="line">    int result &#x3D; size;</span><br><span class="line">    &#x2F;&#x2F; 获取宽&#x2F;高测量规格的模式 &amp; 测量大小</span><br><span class="line">    int specMode &#x3D; MeasureSpec.getMode(measureSpec);</span><br><span class="line">    int specSize &#x3D; MeasureSpec.getSize(measureSpec);</span><br><span class="line">    </span><br><span class="line">    switch (specMode) &#123;</span><br><span class="line">    case MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result &#x3D; size;</span><br><span class="line">        break;</span><br><span class="line">    &#x2F;&#x2F; 模式为AT_MOST,EXACTLY时，使用View测量后的宽&#x2F;高值 &#x3D; measureSpec中的Size</span><br><span class="line">    </span><br><span class="line">    case MeasureSpec.AT_MOST:  </span><br><span class="line">    case MeasureSpec.AT_MOST:</span><br><span class="line">    case MeasureSpec.EXACTLY:</span><br><span class="line">        result &#x3D; specSize;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 存储测量后的View宽 &#x2F; 高 </span><br><span class="line">protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) &#123;</span><br><span class="line">    boolean optical &#x3D; isLayoutModeOptical(this);</span><br><span class="line">        if (optical !&#x3D; isLayoutModeOptical(mParent)) &#123;</span><br><span class="line">            Insets insets &#x3D; getOpticalInsets();</span><br><span class="line">            int opticalWidth  &#x3D; insets.left + insets.right;</span><br><span class="line">            int opticalHeight &#x3D; insets.top  + insets.bottom;</span><br><span class="line">            </span><br><span class="line">            measuredWidth  +&#x3D; optical ? opticalWidth  : -opticalWidth;</span><br><span class="line">            measuredHeight +&#x3D; optical ? opticalHeight : -opticalHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) &#123;</span><br><span class="line">    mMeasuredWidth &#x3D; measuredWidth;</span><br><span class="line">    mMeasuredHeight &#x3D; measuredHeight;</span><br><span class="line">    </span><br><span class="line">    mPrivateFlags |&#x3D; PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ViewGroup-onMeasure"><a href="#ViewGroup-onMeasure" class="headerlink" title="ViewGroup.onMeasure"></a>ViewGroup.onMeasure</h4><p>参考：<a href="https://www.jianshu.com/p/e893950d6cb3" target="_blank" rel="noopener">Android图形系统—View之LinearLayout.measure分析</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) &#123;</span><br><span class="line">    &#x2F;&#x2F; ViewGroup 继承类，大体都要充写次方法，大体模式如下</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 遍历子View，对子控件一一measure</span><br><span class="line">    for(int i&#x3D;0;i&lt;size;++i)&#123;</span><br><span class="line">        measureChild(child, widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 合并所有子控件大小，计算出父控件宽高测量规格</span><br><span class="line">    mergeChildSpec() ; &#x2F;&#x2F; 也有可能与第一步同时计算</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 设置父控件的宽&#x2F;高值</span><br><span class="line">    setMeasuredDimension(widthMeasure,  heightMeasure);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/16/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F-View%E6%B5%8B%E9%87%8F%E8%A7%84%E6%A0%BC%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/16/Android%E5%9B%BE%E5%BD%A2%E7%B3%BB%E7%BB%9F-View%E6%B5%8B%E9%87%8F%E8%A7%84%E6%A0%BC%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Android图形系统-View测量规格解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-16 19:46:53" itemprop="dateCreated datePublished" datetime="2019-11-16T19:46:53+08:00">2019-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:09:31" itemprop="dateModified" datetime="2020-02-07T01:09:31+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="图文概括"><a href="#图文概括" class="headerlink" title="图文概括"></a>图文概括</h3><p><img src="https://upload-images.jianshu.io/upload_images/9696036-e3eac09a50090ec5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-b47728a137279df6.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="View-Measure-类分析"><a href="#View-Measure-类分析" class="headerlink" title="View.Measure 类分析"></a>View.Measure 类分析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public static class MeasureSpec &#123;</span><br><span class="line">    &#x2F;&#x2F; 进位大小 &#x3D; 2的30次方</span><br><span class="line">    private static final int MODE_SHIFT &#x3D; 30;  </span><br><span class="line">        </span><br><span class="line">    &#x2F;&#x2F; 运算遮罩：0x3为16进制，二进制为11，向左进30位</span><br><span class="line">    &#x2F;&#x2F; &#x3D; 11 00 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">    private static final int MODE_MASK  &#x3D; 0x3 &lt;&lt; MODE_SHIFT;  </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; UNSPECIFIED的模式设置：0向左进位30 &#x3D; 00后跟30个0，即00 00000000000</span><br><span class="line">    public static final int UNSPECIFIED &#x3D; 0 &lt;&lt; MODE_SHIFT;  </span><br><span class="line">      </span><br><span class="line">    &#x2F;&#x2F; EXACTLY的模式设置：1向左进位30 &#x3D; 01后跟30个0 ，即01 00000000000</span><br><span class="line">    public static final int EXACTLY &#x3D; 1 &lt;&lt; MODE_SHIFT;  </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; AT_MOST的模式设置：2向左进位30 &#x3D; 10后跟30个0，即10 0000000000</span><br><span class="line">    public static final int AT_MOST &#x3D; 2 &lt;&lt; MODE_SHIFT;  </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 根据提供的size和mode得到测量规格，即measureSpec</span><br><span class="line">    public static int makeMeasureSpec(int size, int mode) &#123;  </span><br><span class="line">     &#x2F;&#x2F; 设计目的：使用一个32位的二进制数，其中：32和31位代表测量模式（mode）、后30位代表测量大小（size）</span><br><span class="line">         return size + mode;  </span><br><span class="line">     &#125;  </span><br><span class="line">    </span><br><span class="line">     </span><br><span class="line">    &#x2F;&#x2F; 通过measureSpec获得测量模式（mode）</span><br><span class="line">    public static int getMode(int measureSpec) &#123;  </span><br><span class="line">      &#x2F;&#x2F;位运算：保留measureSpec的高2位（即测量模式）、使用0替换后30位</span><br><span class="line">         return (measureSpec &amp; MODE_MASK);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    &#x2F;&#x2F; 通过measureSpec获得测量大小size    </span><br><span class="line">    public static int getSize(int measureSpec) &#123;  </span><br><span class="line">      &#x2F;&#x2F; 位运算，即 将MODE_MASK取反，也就是变成了00 111111(00后跟30个1)，将32,31替换成0也就是去掉mode，保留后30位的size  </span><br><span class="line">         return (measureSpec &amp; ~MODE_MASK);  </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="ViewGroup-getChildMeasureSpec-方法分析"><a href="#ViewGroup-getChildMeasureSpec-方法分析" class="headerlink" title="ViewGroup.getChildMeasureSpec 方法分析"></a>ViewGroup.getChildMeasureSpec 方法分析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 根据父视图的MeasureSpec &amp; 布局参数LayoutParams，计算单个子View的MeasureSpec</span><br><span class="line">&#x2F;&#x2F; @param spec 父view的详细测量值(MeasureSpec) </span><br><span class="line">&#x2F;&#x2F; @param padding view当前尺寸的的内边距和外边距(padding,margin) </span><br><span class="line">&#x2F;&#x2F; @param childDimension 子视图的布局参数（宽&#x2F;高）</span><br><span class="line">public static int getChildMeasureSpec(int spec, int padding, int childDimension) &#123;</span><br><span class="line">    &#x2F;&#x2F; 父view的测量模式  父view的大小</span><br><span class="line">    int specMode &#x3D; MeasureSpec.getMode(spec);</span><br><span class="line">    int specSize &#x3D; MeasureSpec.getSize(spec);</span><br><span class="line">    &#x2F;&#x2F; 通过父view计算出的子view &#x3D; 父大小-边距（父要求的大小，但子view不一定用这个值） </span><br><span class="line">    int size &#x3D; Math.max(0, specSize - padding);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 声明子view想要的实际大小和模式</span><br><span class="line">    int resultSize &#x3D; 0;</span><br><span class="line">    int resultMode &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    switch (specMode) &#123;</span><br><span class="line">        &#x2F;&#x2F; 当父view的模式为EXACITY时，父view强加给子view确切的值</span><br><span class="line">        &#x2F;&#x2F; 一般是父view设置为match_parent或者固定值的ViewGroup </span><br><span class="line">        case MeasureSpec.EXACTLY:  </span><br><span class="line">             &#x2F;&#x2F; 当子view的LayoutParams&gt;0，即有确切的值  </span><br><span class="line">            if (childDimension &gt;&#x3D; 0) &#123;</span><br><span class="line">                resultSize &#x3D; childDimension;</span><br><span class="line">                resultMode &#x3D; MeasureSpec.EXACTLY;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">             &#x2F;&#x2F; 当子view的LayoutParams为MATCH_PARENT时(-1) </span><br><span class="line">             &#x2F;&#x2F; 子view大小为父view大小，模式为EXACTLY  </span><br><span class="line">                resultSize &#x3D; size;</span><br><span class="line">                resultMode &#x3D; MeasureSpec.EXACTLY;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">                &#x2F;&#x2F;子view决定自己的大小，但最大不能超过父view，模式为AT_MOST  </span><br><span class="line">                resultSize &#x3D; size;</span><br><span class="line">                resultMode &#x3D; MeasureSpec.AT_MOST;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 当父view的模式为AT_MOST时，父view强加给子view一个最大的值。（一般是父view设置为wrap_content）  </span><br><span class="line">        case MeasureSpec.AT_MOST:</span><br><span class="line">            if (childDimension &gt;&#x3D; 0) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants a specific size... so be it</span><br><span class="line">            resultSize &#x3D; childDimension;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.EXACTLY;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants to be our size, but our size is not fixed.</span><br><span class="line">            &#x2F;&#x2F; Constrain child to not be bigger than us.</span><br><span class="line">            resultSize &#x3D; size;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.AT_MOST;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants to determine its own size. It can&#39;t be</span><br><span class="line">            &#x2F;&#x2F; bigger than us.</span><br><span class="line">            resultSize &#x3D; size;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.AT_MOST;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    </span><br><span class="line">         &#x2F;&#x2F; 当父view的模式为UNSPECIFIED时，父容器不对view有任何限制，要多大给多大</span><br><span class="line">        &#x2F;&#x2F; 多见于ListView、GridView  </span><br><span class="line">        case MeasureSpec.UNSPECIFIED:</span><br><span class="line">            if (childDimension &gt;&#x3D; 0) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants a specific size... let him have it</span><br><span class="line">            resultSize &#x3D; childDimension;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.EXACTLY;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants to be our size... find out how big it should</span><br><span class="line">            &#x2F;&#x2F; be</span><br><span class="line">            resultSize &#x3D; View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.UNSPECIFIED;</span><br><span class="line">            &#125; else if (childDimension &#x3D;&#x3D; LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            &#x2F;&#x2F; Child wants to determine its own size.... find out how</span><br><span class="line">            &#x2F;&#x2F; big it should be</span><br><span class="line">            resultSize &#x3D; View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;</span><br><span class="line">            resultMode &#x3D; MeasureSpec.UNSPECIFIED;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<hr>
<p>推荐阅读：<a href="https://www.jianshu.com/p/238eb0a17760" target="_blank" rel="noopener">图形系统总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://afree8909.github.io/blog/2019/11/06/Android%E2%80%94adb%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Afree">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afree's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/2019/11/06/Android%E2%80%94adb%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Android—adb常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-06 23:02:11" itemprop="dateCreated datePublished" datetime="2019-11-06T23:02:11+08:00">2019-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-07 01:09:05" itemprop="dateModified" datetime="2020-02-07T01:09:05+08:00">2020-02-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87/" itemprop="url" rel="index"><span itemprop="name">开发效率</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Android/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是adb"><a href="#什么是adb" class="headerlink" title="什么是adb"></a>什么是adb</h2><p>ADB全称Android Debug Bridge, 是android sdk里的一个工具, 用这个工具可以直接操作管理android模拟器或者真实的andriod设备(手机)。</p>
<h2 id="adb命令的主要用途"><a href="#adb命令的主要用途" class="headerlink" title="adb命令的主要用途"></a>adb命令的主要用途</h2><ol>
<li>运行android设备的shell(命令行)</li>
<li>管理模拟器或android设备的映射端口</li>
<li>安装和卸载应用程序</li>
<li>计算机和android设备之间的上传和下载文件。</li>
</ol>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="指定设备"><a href="#指定设备" class="headerlink" title="指定设备"></a>指定设备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;  显示所有已连接上adb的设备</span><br><span class="line">adb devices       </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;  使用adb devices中展示的第一个真机作为$command目标</span><br><span class="line">adb -d $command  </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 使用adb devices中展示的第一个模拟器作为$command目标 </span><br><span class="line">adb -e $command  </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 使用adb devices中展示的特定serialNumber的devices作为$command目标</span><br><span class="line">adb -s &lt;serialNumber&gt; $command</span><br></pre></td></tr></table></figure>
<h3 id="安装-amp-卸载"><a href="#安装-amp-卸载" class="headerlink" title="安装&amp;卸载"></a>安装&amp;卸载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb install</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 适合覆盖&#x2F;升级安装（前提是apk的签名一致，如果不一致，请卸载后再安装）</span><br><span class="line">adb install -r  </span><br><span class="line"></span><br><span class="line">adb uninstall $packageName</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 保留数据信息，但是要求新安装的apk保持一致的签名</span><br><span class="line">adb uninstall -k $packageName</span><br></pre></td></tr></table></figure>
<h3 id="上传-amp-下载"><a href="#上传-amp-下载" class="headerlink" title="上传&amp;下载"></a>上传&amp;下载</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从电脑传文件到手机</span><br><span class="line">adb push &#x2F;users&#x2F;desktop &#x2F;sdcard&#x2F;data&#x2F;   </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 从手机传文件到电脑</span><br><span class="line">adb pull &#x2F;sdcard&#x2F;screenshot.png &#x2F;users&#x2F;desktop</span><br></pre></td></tr></table></figure>
<h3 id="shell相关"><a href="#shell相关" class="headerlink" title="shell相关"></a>shell相关</h3><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> &#x2F;&#x2F; 通过scheme打开页面</span><br><span class="line">adb shell am start -d $&#123;appScheme&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 通过package打开</span><br><span class="line">adb shell start $&#123;packageName&#125; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 通过Activity打开</span><br><span class="line">adb shell am start -n $&#123;Activity&#125;</span><br></pre></td></tr></table></figure>
<h4 id="清除"><a href="#清除" class="headerlink" title="清除"></a>清除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; uninstall卸载   </span><br><span class="line">adb shell pm uninstall $&#123;packageName&#125;    </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; clear清除数据   </span><br><span class="line">adb shell pm clear $&#123;packageName&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dumpsys"><a href="#dumpsys" class="headerlink" title="dumpsys"></a>dumpsys</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 获取Activity信息</span><br><span class="line">adb shell dumpsys activity</span><br><span class="line">adb shell dumpsys activity top</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 获取cpu信息</span><br><span class="line">adb shell dumpsys cpuinfo</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 获取设备电池信息</span><br><span class="line">adb shell dumpsys </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 获取电源管理信息</span><br><span class="line">adb shell dumpsys power</span><br></pre></td></tr></table></figure>

<h3 id="截屏与录屏"><a href="#截屏与录屏" class="headerlink" title="截屏与录屏"></a>截屏与录屏</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;截屏</span><br><span class="line">adb shell screencap  &#x2F;sdcard&#x2F;screen.png   </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 录屏  </span><br><span class="line">adb shell screenrecord -size 720*1280  &#x2F;sdcard&#x2F;record.mp4</span><br></pre></td></tr></table></figure>
<h3 id="屏幕参数"><a href="#屏幕参数" class="headerlink" title="屏幕参数"></a>屏幕参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 屏幕分辨率</span><br><span class="line">adb shell wm size    </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 屏幕密度  </span><br><span class="line">adb shell wm density</span><br></pre></td></tr></table></figure>
<h3 id="系统参数"><a href="#系统参数" class="headerlink" title="系统参数"></a>系统参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 系统版本</span><br><span class="line">adb shell getprop ro.build.version.release</span><br></pre></td></tr></table></figure>

<h3 id="logcat"><a href="#logcat" class="headerlink" title="logcat"></a>logcat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;手机本地log导出</span><br><span class="line">adb logcat -d &gt;&gt; ~&#x2F;Desktop&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 手机ANR log导出 </span><br><span class="line">adb pull &#x2F;data&#x2F;anr&#x2F;traces.txt </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 输出 Error&#x2F;Fatal 日志</span><br><span class="line">adb logcat *:ef</span><br></pre></td></tr></table></figure>




<hr>
<p><img src="https://upload-images.jianshu.io/upload_images/9696036-70673e2d55e85b18.gif?imageMogr2/auto-orient/strip" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/blog/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/6/">6</a><a class="extend next" rel="next" href="/blog/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Afree</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Afree</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/pisces.js"></script>


<script src="/blog/js/next-boot.js"></script>




  




  
<script src="/blog/js/local-search.js"></script>













  

  


</body>
</html>
